

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>simdeep.simdeep_analysis &mdash; DeepProg  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> DeepProg
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Tutorial: Simple DeepProg model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage_ensemble.html">Tutorial: Ensemble of DeepProg model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage_advanced.html">Tutorial: Advanced usage of DeepProg model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../case_study.html">Case study: Analyzing TCGA HCC dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage_tuning.html">Tutorial: Tuning DeepProg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/simdeep.html">simdeep package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DeepProg</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>simdeep.simdeep_analysis</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for simdeep.simdeep_analysis</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">DeepProg class for one instance model</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">sklearn.mixture</span> <span class="kn">import</span> <span class="n">GaussianMixture</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_score</span>

<span class="kn">from</span> <span class="nn">simdeep.deepmodel_base</span> <span class="kn">import</span> <span class="n">DeepBase</span>

<span class="kn">from</span> <span class="nn">simdeep.survival_model_utils</span> <span class="kn">import</span> <span class="n">ClusterWithSurvival</span>

<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">NB_CLUSTERS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CLUSTER_ARRAY</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">PVALUE_THRESHOLD</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CINDEX_THRESHOLD</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CLASSIFIER_TYPE</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">USE_AUTOENCODERS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">FEATURE_SURV_ANALYSIS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">SEED</span>

<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">MIXTURE_PARAMS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">PATH_RESULTS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">PROJECT_NAME</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CLASSIFICATION_METHOD</span>

<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CLUSTER_EVAL_METHOD</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CLUSTER_METHOD</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">NB_THREADS_COXPH</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">NB_SELECTED_FEATURES</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">LOAD_EXISTING_MODELS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">NODES_SELECTION</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CLASSIFIER</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">HYPER_PARAMETERS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">PATH_TO_SAVE_MODEL</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CLUSTERING_OMICS</span>

<span class="kn">from</span> <span class="nn">simdeep.survival_utils</span> <span class="kn">import</span> <span class="n">_process_parallel_coxph</span>
<span class="kn">from</span> <span class="nn">simdeep.survival_utils</span> <span class="kn">import</span> <span class="n">_process_parallel_cindex</span>
<span class="kn">from</span> <span class="nn">simdeep.survival_utils</span> <span class="kn">import</span> <span class="n">_process_parallel_feature_importance</span>
<span class="kn">from</span> <span class="nn">simdeep.survival_utils</span> <span class="kn">import</span> <span class="n">_process_parallel_feature_importance_per_cluster</span>
<span class="kn">from</span> <span class="nn">simdeep.survival_utils</span> <span class="kn">import</span> <span class="n">select_best_classif_params</span>

<span class="kn">from</span> <span class="nn">simdeep.simdeep_utils</span> <span class="kn">import</span> <span class="n">metadata_usage_type</span>
<span class="kn">from</span> <span class="nn">simdeep.simdeep_utils</span> <span class="kn">import</span> <span class="n">feature_selection_usage_type</span>

<span class="kn">from</span> <span class="nn">simdeep.simdeep_utils</span> <span class="kn">import</span> <span class="n">load_labels_file</span>

<span class="kn">from</span> <span class="nn">simdeep.coxph_from_r</span> <span class="kn">import</span> <span class="n">coxph</span>
<span class="kn">from</span> <span class="nn">simdeep.coxph_from_r</span> <span class="kn">import</span> <span class="n">c_index</span>
<span class="kn">from</span> <span class="nn">simdeep.coxph_from_r</span> <span class="kn">import</span> <span class="n">c_index_multiple</span>

<span class="kn">from</span> <span class="nn">simdeep.coxph_from_r</span> <span class="kn">import</span> <span class="n">surv_median</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_score</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">calinski_harabasz_score</span> \
        <span class="k">as</span> <span class="n">calinski_harabaz_score</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">calinski_harabaz_score</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">hstack</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isdir</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">mkdir</span>


<span class="c1">################ VARIABLE ############################################</span>
<span class="n">_CLASSIFICATION_METHOD_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ALL_FEATURES&#39;</span><span class="p">,</span> <span class="s1">&#39;SURVIVAL_FEATURES&#39;</span><span class="p">]</span>
<span class="n">MODEL_THRES</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="c1">######################################################################</span>


<div class="viewcode-block" id="SimDeep"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep">[docs]</a><span class="k">class</span> <span class="nc">SimDeep</span><span class="p">(</span><span class="n">DeepBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instanciate a new DeepProg instance.</span>
<span class="sd">    The default parameters are defined in the config.py file</span>

<span class="sd">    Parameters:</span>
<span class="sd">             :dataset: ExtractData instance. Default None (create a new dataset using the config variable)</span>
<span class="sd">             :nb_clusters: Number of clusters to search (default NB_CLUSTERS)</span>
<span class="sd">             :pvalue_thres: Pvalue threshold to include a feature  (default PVALUE_THRESHOLD)</span>
<span class="sd">             :clustering_omics: Which omics to use for clustering. If empty, then all the available omics will be used</span>
<span class="sd">             :cindex_thres: C-index threshold to include a feature. This parameter is used only if `node_selection` is set to &quot;C-index&quot; (default CINDEX_THRESHOLD)</span>
<span class="sd">             :cluster_method: Cluster method to use. possible choice [&#39;mixture&#39;, &#39;kmeans&#39;]. (default CLUSTER_METHOD)</span>
<span class="sd">             :cluster_eval_method: Cluster evaluation method to use in case the `cluster_array` parameter is a list of possible K. Possible choice [&#39;bic&#39;, &#39;silhouette&#39;, &#39;calinski&#39;] (default CLUSTER_EVAL_METHOD)</span>
<span class="sd">             :classifier_type: Type of classifier to use. Possible choice [&#39;svm&#39;, &#39;clustering&#39;]. If &#39;clustering&#39; is selected, The predict method of the clustering algoritm is used  (default CLASSIFIER_TYPE)</span>
<span class="sd">             :project_name: Name of the project. This name will be used to save the output files and create the output folder (default PROJECT_NAME)</span>
<span class="sd">             :path_results: Result folder path used to save the output files (default PATH_RESULTS)</span>
<span class="sd">             :cluster_array: Array of possible number of clusters to try. If set, `nb_clusters` is ignored (default CLUSTER_ARRAY)</span>
<span class="sd">             :nb_selected_features: Number of selected features to construct classifiers (default NB_SELECTED_FEATURES)</span>
<span class="sd">             :mixture_params: Dictionary of parameters used to instanciate the Gaussian mixture algorithm (default MIXTURE_PARAMS)</span>
<span class="sd">             :node_selection: Mehtod to select new features. possible choice [&#39;Cox-PH&#39;, &#39;C-index&#39;]. (default NODES_SELECTION)</span>
<span class="sd">             :nb_threads_coxph: Number of python processes to use to compute individual survival models in parallel (default NB_THREADS_COXPH)</span>
<span class="sd">             :classification_method: Possible choice  [&#39;ALL_FEATURES&#39;, &#39;SURVIVAL_FEATURES&#39;]. If &#39;SURVIVAL_FEATURES&#39; is selected, the classifiers are built using survival features  (default CLASSIFICATION_METHOD)</span>
<span class="sd">             :load_existing_models: (default LOAD_EXISTING_MODELS)</span>
<span class="sd">             :path_to_save_model: (default PATH_TO_SAVE_MODEL)</span>
<span class="sd">             :metadata_usage: Meta data usage with survival models (if metadata_tsv provided as argument to the dataset). Possible choice are [None, False, &#39;labels&#39;, &#39;new-features&#39;, &#39;all&#39;, True] (True is the same as all)</span>
<span class="sd">             :feature_selection_usage: selection method for survival features (&#39;individual&#39; or &#39;lasso&#39;)</span>
<span class="sd">             :alternative_embedding: alternative external embedding to use instead of builfing autoencoders (default None)</span>
<span class="sd">             :kwargs_alternative_embedding: parameters for external embedding fitting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">nb_clusters</span><span class="o">=</span><span class="n">NB_CLUSTERS</span><span class="p">,</span>
                 <span class="n">pvalue_thres</span><span class="o">=</span><span class="n">PVALUE_THRESHOLD</span><span class="p">,</span>
                 <span class="n">cindex_thres</span><span class="o">=</span><span class="n">CINDEX_THRESHOLD</span><span class="p">,</span>
                 <span class="n">use_autoencoders</span><span class="o">=</span><span class="n">USE_AUTOENCODERS</span><span class="p">,</span>
                 <span class="n">feature_surv_analysis</span><span class="o">=</span><span class="n">FEATURE_SURV_ANALYSIS</span><span class="p">,</span>
                 <span class="n">cluster_method</span><span class="o">=</span><span class="n">CLUSTER_METHOD</span><span class="p">,</span>
                 <span class="n">cluster_eval_method</span><span class="o">=</span><span class="n">CLUSTER_EVAL_METHOD</span><span class="p">,</span>
                 <span class="n">classifier_type</span><span class="o">=</span><span class="n">CLASSIFIER_TYPE</span><span class="p">,</span>
                 <span class="n">project_name</span><span class="o">=</span><span class="n">PROJECT_NAME</span><span class="p">,</span>
                 <span class="n">path_results</span><span class="o">=</span><span class="n">PATH_RESULTS</span><span class="p">,</span>
                 <span class="n">cluster_array</span><span class="o">=</span><span class="n">CLUSTER_ARRAY</span><span class="p">,</span>
                 <span class="n">nb_selected_features</span><span class="o">=</span><span class="n">NB_SELECTED_FEATURES</span><span class="p">,</span>
                 <span class="n">mixture_params</span><span class="o">=</span><span class="n">MIXTURE_PARAMS</span><span class="p">,</span>
                 <span class="n">node_selection</span><span class="o">=</span><span class="n">NODES_SELECTION</span><span class="p">,</span>
                 <span class="n">nb_threads_coxph</span><span class="o">=</span><span class="n">NB_THREADS_COXPH</span><span class="p">,</span>
                 <span class="n">classification_method</span><span class="o">=</span><span class="n">CLASSIFICATION_METHOD</span><span class="p">,</span>
                 <span class="n">load_existing_models</span><span class="o">=</span><span class="n">LOAD_EXISTING_MODELS</span><span class="p">,</span>
                 <span class="n">path_to_save_model</span><span class="o">=</span><span class="n">PATH_TO_SAVE_MODEL</span><span class="p">,</span>
                 <span class="n">clustering_omics</span><span class="o">=</span><span class="n">CLUSTERING_OMICS</span><span class="p">,</span>
                 <span class="n">metadata_usage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">feature_selection_usage</span><span class="o">=</span><span class="s1">&#39;individual&#39;</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">,</span>
                 <span class="n">alternative_embedding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">do_KM_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">_isboosting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">kwargs_alternative_embedding</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">deep_model_additional_args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span> <span class="o">=</span> <span class="n">nb_clusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_thres</span> <span class="o">=</span> <span class="n">pvalue_thres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cindex_thres</span> <span class="o">=</span> <span class="n">cindex_thres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_autoencoders</span> <span class="o">=</span> <span class="n">use_autoencoders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_surv_analysis</span> <span class="o">=</span> <span class="n">feature_surv_analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">CLASSIFIER</span><span class="p">(),</span> <span class="n">HYPER_PARAMETERS</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_array</span> <span class="o">=</span> <span class="n">cluster_array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span> <span class="o">=</span> <span class="n">path_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_omics</span> <span class="o">=</span> <span class="n">clustering_omics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_usage</span> <span class="o">=</span> <span class="n">metadata_usage_type</span><span class="p">(</span><span class="n">metadata_usage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_selection_usage</span> <span class="o">=</span> <span class="n">feature_selection_usage_type</span><span class="p">(</span>
            <span class="n">feature_selection_usage</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span> <span class="o">=</span> <span class="n">alternative_embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs_alternative_embedding</span> <span class="o">=</span> <span class="n">kwargs_alternative_embedding</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">):</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mixture_params</span> <span class="o">=</span> <span class="n">mixture_params</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_KM_plot</span> <span class="o">=</span> <span class="n">do_KM_plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_threads_coxph</span> <span class="o">=</span> <span class="n">nb_threads_coxph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classification_method</span> <span class="o">=</span> <span class="n">classification_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_selected_features</span> <span class="o">=</span> <span class="n">nb_selected_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_selection</span> <span class="o">=</span> <span class="n">node_selection</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_pvalue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_pvalue_proba</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_pvalue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_pvalue_proba</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_pvalue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_pvalue_proba</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_pvalue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_pvalue_proba</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_for_kde_plot_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main_kernel</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier_type</span> <span class="o">=</span> <span class="n">classifier_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">used_normalization</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">used_features_for_classif</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_isboosting</span> <span class="o">=</span> <span class="n">_isboosting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pretrained_model</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">valid_node_ids_array</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activities_array</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activities_pred_array</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_node_ids_array</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activities_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activities_cv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activities_for_pred_train</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activities_for_pred_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activities_for_pred_cv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_labels_proba</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">training_omic_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_omic_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_label_ordered_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_performance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bic_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silhouette_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calinski_score</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span> <span class="o">=</span> <span class="n">cluster_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_eval_method</span> <span class="o">=</span> <span class="n">cluster_eval_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_existing_models</span> <span class="o">=</span> <span class="n">load_existing_models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_features_scores_changed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path_to_save_model</span> <span class="o">=</span> <span class="n">path_to_save_model</span>

        <span class="n">deep_model_additional_args</span><span class="p">[</span><span class="s1">&#39;path_to_save_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_to_save_model</span>

        <span class="n">DeepBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                          <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                          <span class="n">alternative_embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span><span class="p">,</span>
                          <span class="n">kwargs_alternative_embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs_alternative_embedding</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">deep_model_additional_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_look_for_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_selection</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Cox-PH&#39;</span><span class="p">,</span> <span class="s1">&#39;C-index&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_usage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;new-features&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata_mat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata_mat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_selection</span> <span class="o">==</span> <span class="s1">&#39;Cox-PH&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_look_for_survival_nodes</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_selection</span> <span class="o">==</span> <span class="s1">&#39;C-index&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_look_for_prediction_nodes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<div class="viewcode-block" id="SimDeep.load_new_test_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.load_new_test_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">load_new_test_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsv_dict</span><span class="p">,</span>
                              <span class="n">fname_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">path_survival_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">normalization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">survival_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">metadata_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">load_new_test_dataset</span><span class="p">(</span>
            <span class="n">tsv_dict</span><span class="p">,</span>
            <span class="n">path_survival_file</span><span class="p">,</span>
            <span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span><span class="p">,</span>
            <span class="n">survival_flag</span><span class="o">=</span><span class="n">survival_flag</span><span class="p">,</span>
            <span class="n">metadata_file</span><span class="o">=</span><span class="n">metadata_file</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">normalization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">normalization</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">normalization</span>
                <span class="k">if</span> <span class="n">normalization</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalization</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalization</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalization</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_normalization</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;recombuting feature scores...&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_feature_scores</span><span class="p">(</span><span class="n">use_ref</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_features_scores_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">fname_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project_name</span><span class="p">,</span> <span class="n">fname_key</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimDeep.fit_on_pretrained_label_file"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.fit_on_pretrained_label_file">[docs]</a>    <span class="k">def</span> <span class="nf">fit_on_pretrained_label_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        fit a deepprog simdeep model without training autoencoder but just using a ID-&gt;labels file to train a classifier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pretrained_model</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_autoencoders</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_surv_analysis</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">load_array</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">load_survival</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">load_meta_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">subset_training_sets</span><span class="p">()</span>

        <span class="n">labels_dict</span> <span class="o">=</span> <span class="n">load_labels_file</span><span class="p">(</span><span class="n">label_file</span><span class="p">)</span>

        <span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">labels_proba</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">labels_dict</span><span class="p">:</span>
                <span class="n">train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="n">label</span><span class="p">,</span> <span class="n">label_proba</span> <span class="o">=</span> <span class="n">labels_dict</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span>

                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="n">labels_proba</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_proba</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">cross_validation_instance</span> <span class="o">=</span> <span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">cross_validation_instance</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">create_a_cv_split</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalize_training_array</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">matrix_train_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_train_array</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_train_array</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">matrix_train_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_train_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">training_omic_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">training_tsv</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predict_labels_using_external_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">labels_proba</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">used_normalization</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalization</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                   <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalization</span>
                                   <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalization</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">used_features_for_classif</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">feature_train_array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">look_for_survival_nodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_classification_model</span><span class="p">()</span></div>

<div class="viewcode-block" id="SimDeep.predict_labels_using_external_labels"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.predict_labels_using_external_labels">[docs]</a>    <span class="k">def</span> <span class="nf">predict_labels_using_external_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">labels_proba</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="n">nb_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">labels_proba</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_clusters</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

        <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">pvalue</span> <span class="o">=</span> <span class="n">coxph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span>
                       <span class="n">isfactor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">do_KM_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_KM_plot</span><span class="p">,</span>
                       <span class="n">png_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span>
                       <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                       <span class="n">fig_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_KM_plot_training_dataset&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">))</span>

        <span class="n">pvalue_proba</span> <span class="o">=</span> <span class="n">coxph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span>
                             <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                             <span class="n">isfactor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isboosting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                               <span class="n">labels_proba</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_training_set_labels&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cox-PH p-value (Log-Rank) for the cluster labels: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pvalue</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_pvalue</span> <span class="o">=</span> <span class="n">pvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_pvalue_proba</span> <span class="o">=</span> <span class="n">pvalue_proba</span></div>

<div class="viewcode-block" id="SimDeep.fit"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        main function</span>
<span class="sd">        I) construct an autoencoder or fit alternative embedding</span>
<span class="sd">        II) predict nodes linked with survival (if active)</span>
<span class="sd">        and III) do clustering</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_existing_models</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_encoders</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_model_loaded</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit_alternative_embedding</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">construct_autoencoders</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">look_for_survival_nodes</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">training_omic_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder_array</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_labels</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">used_normalization</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalization</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                   <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalization</span>
                                   <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalization</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">used_features_for_classif</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">feature_train_array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_classification_model</span><span class="p">()</span></div>

<div class="viewcode-block" id="SimDeep.predict_labels_on_test_fold"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.predict_labels_on_test_fold">[docs]</a>    <span class="k">def</span> <span class="nf">predict_labels_on_test_fold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">cross_validation_instance</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">load_matrix_test_fold</span><span class="p">()</span>

        <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival_cv</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activities_cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_survival_nodes</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_cv_array</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cv_labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_labels</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activities_cv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_cv_array</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#### report of test fold cluster:):&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cv_labels</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;class: </span><span class="si">{0}</span><span class="s1">, number of samples :</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_usage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata_mat_cv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata_mat_cv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_test_coxph</span><span class="p">(</span><span class="s1">&#39;KM_plot_test_fold&#39;</span><span class="p">,</span>
                                                        <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">cv_labels</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">cv_labels_proba</span><span class="p">,</span>
                                                        <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_pvalue</span> <span class="o">=</span> <span class="n">pvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_pvalue_proba</span> <span class="o">=</span> <span class="n">pvalue_proba</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isboosting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sample_ids_cv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_labels</span><span class="p">,</span>
                               <span class="n">labels_proba</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cv_labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_test_fold_labels&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_labels</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span></div>

<div class="viewcode-block" id="SimDeep.predict_labels_on_full_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.predict_labels_on_full_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">predict_labels_on_full_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">load_matrix_full</span><span class="p">()</span>

        <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival_full</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activities_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_survival_nodes</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_full_array</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_labels</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activities_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_full_array</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#### report of assigned cluster for full dataset:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;class: </span><span class="si">{0}</span><span class="s1">, number of samples :</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_usage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata_mat_full</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata_mat_full</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_test_coxph</span><span class="p">(</span><span class="s1">&#39;KM_plot_full&#39;</span><span class="p">,</span>
                                                        <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span><span class="p">,</span>
                                                        <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_pvalue</span> <span class="o">=</span> <span class="n">pvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_pvalue_proba</span> <span class="o">=</span> <span class="n">pvalue_proba</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isboosting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sample_ids_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">,</span>
                               <span class="n">labels_proba</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_full_labels&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span></div>

<div class="viewcode-block" id="SimDeep.predict_labels_on_test_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.predict_labels_on_test_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">predict_labels_on_test_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival_test</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_omic_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_test_array</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_omic_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_omic_list</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training_omic_list</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_omic_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;in predict_labels_on_test_dataset: test_omic_list is empty!&#39;</span>\
                            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> either no common omic with trining_omic_list or error!&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit_classification_test_model</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activities_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_survival_nodes</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_test_array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict_test_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_test</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_test_array</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#### report of assigned cluster:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;class: </span><span class="si">{0}</span><span class="s1">, number of samples :</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_usage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;test-labels&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata_mat_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata_mat_test</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_test_coxph</span><span class="p">(</span><span class="s1">&#39;KM_plot_test&#39;</span><span class="p">,</span>
                                                        <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="p">,</span>
                                                        <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_pvalue</span> <span class="o">=</span> <span class="n">pvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_pvalue_proba</span> <span class="o">=</span> <span class="n">pvalue_proba</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">nbdays</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_test_coxph</span><span class="p">(</span>
                    <span class="s1">&#39;KM_plot_test&#39;</span><span class="p">,</span>
                    <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">test_pvalue</span> <span class="o">=</span> <span class="n">pvalue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_pvalue_proba</span> <span class="o">=</span> <span class="n">pvalue_proba</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isboosting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sample_ids_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">,</span>
                               <span class="n">labels_proba</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_test_labels&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span></div>

    <span class="k">def</span> <span class="nf">_compute_test_coxph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">fname_base</span><span class="p">,</span>
                            <span class="n">nbdays</span><span class="p">,</span>
                            <span class="n">isdead</span><span class="p">,</span>
                            <span class="n">labels</span><span class="p">,</span>
                            <span class="n">labels_proba</span><span class="p">,</span>
                            <span class="n">metadata_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">pvalue</span> <span class="o">=</span> <span class="n">coxph</span><span class="p">(</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span>
            <span class="n">isfactor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">do_KM_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_KM_plot</span><span class="p">,</span>
            <span class="n">png_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">,</span>
            <span class="n">fig_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cox-PH p-value (Log-Rank) for inferred labels: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pvalue</span><span class="p">))</span>

        <span class="n">pvalue_proba</span> <span class="o">=</span> <span class="n">coxph</span><span class="p">(</span>
            <span class="n">labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span>
            <span class="n">isfactor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">do_KM_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">png_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">,</span>
            <span class="n">fig_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">_proba&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cox-PH proba p-value (Log-Rank) for inferred labels: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pvalue_proba</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span>

<div class="viewcode-block" id="SimDeep.compute_feature_scores"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.compute_feature_scores">[docs]</a>    <span class="k">def</span> <span class="nf">compute_feature_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_ref</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isboosting</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_threads_coxph</span><span class="p">)</span>
            <span class="n">mapf</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span>
            <span class="n">mapf</span> <span class="o">=</span> <span class="nb">map</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mapf</span> <span class="o">=</span> <span class="nb">map</span>

        <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_list</span><span class="p">)):</span>
                <span class="k">yield</span> <span class="n">feature_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">labels</span>

        <span class="k">if</span> <span class="n">use_ref</span><span class="p">:</span>
            <span class="n">key_array</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_ref_array</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key_array</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_train_array</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_array</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_ref</span><span class="p">:</span>
                <span class="n">feature_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">feature_ref_array</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_ref_array</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feature_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">feature_train_array</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_train_array</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[:]</span>

            <span class="n">input_list</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

            <span class="n">features_scored</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mapf</span><span class="p">(</span><span class="n">_process_parallel_feature_importance</span><span class="p">,</span> <span class="n">input_list</span><span class="p">))</span>
            <span class="n">features_scored</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">features_scored</span>

        <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>

<div class="viewcode-block" id="SimDeep.compute_feature_scores_per_cluster"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.compute_feature_scores_per_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">compute_feature_scores_per_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_ref</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                           <span class="n">pval_thres</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;computing feature importance per cluster...&#39;</span><span class="p">)</span>

        <span class="n">mapf</span> <span class="o">=</span> <span class="nb">map</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_list</span><span class="p">)):</span>
                <span class="k">yield</span> <span class="n">feature_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">labels</span><span class="p">,</span> <span class="n">pval_thres</span>

        <span class="k">if</span> <span class="n">use_ref</span><span class="p">:</span>
            <span class="n">key_array</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_ref_array</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key_array</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_train_array</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_array</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_ref</span><span class="p">:</span>
                <span class="n">feature_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">feature_ref_array</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_ref_array</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feature_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">feature_train_array</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_train_array</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[:]</span>

            <span class="n">input_list</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

            <span class="n">features_scored</span> <span class="o">=</span> <span class="n">mapf</span><span class="p">(</span><span class="n">_process_parallel_feature_importance_per_cluster</span><span class="p">,</span> <span class="n">input_list</span><span class="p">)</span>
            <span class="n">features_scored</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span> <span class="k">for</span> <span class="n">feat_list</span> <span class="ow">in</span> <span class="n">features_scored</span> <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feat_list</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">median_diff</span><span class="p">,</span> <span class="n">pvalue</span> <span class="ow">in</span> <span class="n">features_scored</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">feature</span><span class="p">,</span> <span class="n">median_diff</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="SimDeep.write_feature_score_per_cluster"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.write_feature_score_per_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">write_feature_score_per_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f_file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">_features_scores_per_clusters.tsv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_name</span><span class="p">)</span>
        <span class="n">f_anti_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">_features_anticorrelated_scores_per_clusters.tsv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_name</span><span class="p">)</span>

        <span class="n">f_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f_anti_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_anti_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="n">f_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cluster id;feature;median diff;p-value</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">median_diff</span><span class="p">,</span> <span class="n">pvalue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">median_diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">f_to_write</span> <span class="o">=</span> <span class="n">f_file</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f_to_write</span> <span class="o">=</span> <span class="n">f_anti_file</span>

                <span class="n">f_to_write</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">;</span><span class="si">{1}</span><span class="s1">;</span><span class="si">{2}</span><span class="s1">;</span><span class="si">{3}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">median_diff</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> written&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_file_name</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> written&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_anti_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="SimDeep.write_feature_scores"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.write_feature_scores">[docs]</a>    <span class="k">def</span> <span class="nf">write_feature_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">_features_scores.tsv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_file</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores</span><span class="p">:</span>
                <span class="n">f_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#### </span><span class="si">{0}</span><span class="s1"> ####</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">f_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">;</span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">_features_scores.tsv written&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_return_train_matrix_for_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classification_method</span> <span class="ow">in</span> <span class="n">_CLASSIFICATION_METHOD_LIST</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;classification method: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">classification_method</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classification_method</span> <span class="o">==</span> <span class="s1">&#39;SURVIVAL_FEATURES&#39;</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classifier_type</span> <span class="o">!=</span> <span class="s1">&#39;clustering&#39;</span><span class="p">)</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_survival_nodes</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_ref_array</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">classification_method</span> <span class="o">==</span> <span class="s1">&#39;ALL_FEATURES&#39;</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reduce_and_stack_matrices</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_ref_array</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of features for the classifier: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reduce_and_stack_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_selected_features</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstack</span><span class="p">(</span><span class="n">matrices</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_feature_scores</span><span class="p">()</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">matrices</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">feature_ref_index</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">feature</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">pvalue</span> <span class="ow">in</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores</span><span class="p">[</span><span class="n">key</span><span class="p">][:</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_selected_features</span><span class="p">]</span>
                         <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">feature_ref_index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="p">]</span>

                <span class="n">matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matrices</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">hstack</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

<div class="viewcode-block" id="SimDeep.fit_classification_model"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.fit_classification_model">[docs]</a>    <span class="k">def</span> <span class="nf">fit_classification_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">train_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_train_matrix_for_classification</span><span class="p">()</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier_type</span> <span class="o">==</span> <span class="s1">&#39;clustering&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clustering model defined as the classifier&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;classification analysis...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_matrix</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">select_best_classif_params</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier_grid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_matrix</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_normalization</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">cvs</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">,</span> <span class="n">train_matrix</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;best params:&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cross val score: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cvs</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;classification score:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">score</span><span class="p">(</span>
                <span class="n">train_matrix</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span></div>

<div class="viewcode-block" id="SimDeep.fit_classification_test_model"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.fit_classification_test_model">[docs]</a>    <span class="k">def</span> <span class="nf">fit_classification_test_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">is_same_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_features_for_classif</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">feature_ref_array</span>
        <span class="n">is_same_normalization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_normalization</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span>
        <span class="n">is_filled_with_zero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">fill_unkown_feature_with_0</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">is_same_features</span> <span class="ow">and</span> <span class="n">is_same_normalization</span> <span class="ow">and</span> <span class="n">is_filled_with_zero</span><span class="p">)</span>\
           <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier_type</span> <span class="o">==</span> <span class="s1">&#39;clustering&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not rebuilding the test classifier&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">classifier_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;classification for test set analysis...&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">used_normalization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalization_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">used_features_for_classif</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">feature_ref_array</span>

        <span class="n">train_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_train_matrix_for_classification</span><span class="p">()</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_matrix</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier_test</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">select_best_classif_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classifier_grid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier_test</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier_test</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_matrix</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">cvs</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classifier_test</span><span class="p">,</span> <span class="n">train_matrix</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;best params:&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cross val score: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cvs</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;classification score:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier_test</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">train_matrix</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span></div>

<div class="viewcode-block" id="SimDeep.predict_labels"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.predict_labels">[docs]</a>    <span class="k">def</span> <span class="nf">predict_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        predict labels from training set</span>
<span class="sd">        using K-Means algorithm on the node activities,</span>
<span class="sd">        using only nodes linked to survival</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;performing clustering on the omic model with the following key:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">training_omic_list</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span><span class="p">,</span> <span class="s1">&#39;fit_predict&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span> <span class="o">==</span> <span class="s1">&#39;kmeans&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span> <span class="o">==</span> <span class="s1">&#39;mixture&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span> <span class="o">=</span> <span class="n">GaussianMixture</span><span class="p">(</span>
                <span class="n">n_components</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mixture_params</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span> <span class="o">==</span> <span class="s2">&quot;coxPH&quot;</span><span class="p">:</span>
            <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span> <span class="o">=</span> <span class="n">ClusterWithSurvival</span><span class="p">(</span>
                <span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span><span class="p">,</span>
                <span class="n">isdead</span><span class="o">=</span><span class="n">isdead</span><span class="p">,</span>
                <span class="n">nbdays</span><span class="o">=</span><span class="n">nbdays</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span> <span class="o">==</span> <span class="s2">&quot;coxPHMixture&quot;</span><span class="p">:</span>
            <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span> <span class="o">=</span> <span class="n">ClusterWithSurvival</span><span class="p">(</span>
                <span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span><span class="p">,</span>
                <span class="n">use_gaussian_to_dichotomize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">isdead</span><span class="o">=</span><span class="n">isdead</span><span class="p">,</span>
                <span class="n">nbdays</span><span class="o">=</span><span class="n">nbdays</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No method fit and predict found for: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No components linked to survival!&#39;</span>\
                            <span class="s1">&#39; cannot perform clustering&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_array</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_array</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_predict_best_k_for_cluster</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="p">,</span> <span class="s1">&#39;predict&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span><span class="p">)</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_labels_according_to_survival</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="p">,</span> <span class="s1">&#39;predict_proba&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span><span class="p">:</span>
            <span class="n">missing_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">missing_columns</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;clustering done, labels ordered according to survival:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">Counter</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cluster label: </span><span class="si">{0}</span><span class="se">\t</span><span class="s1"> number of samples:</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_usage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata_mat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadata_mat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">pvalue</span> <span class="o">=</span> <span class="n">coxph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span>
                       <span class="n">isfactor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">do_KM_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_KM_plot</span><span class="p">,</span>
                       <span class="n">png_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span>
                       <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                       <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">,</span>
                       <span class="n">fig_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_KM_plot_training_dataset&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">))</span>

        <span class="n">pvalue_proba</span> <span class="o">=</span> <span class="n">coxph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span>
                             <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                             <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">,</span>
                             <span class="n">isfactor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isboosting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                               <span class="n">labels_proba</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_training_set_labels&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cox-PH p-value (Log-Rank) for the cluster labels: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pvalue</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_pvalue</span> <span class="o">=</span> <span class="n">pvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_pvalue_proba</span> <span class="o">=</span> <span class="n">pvalue_proba</span></div>

<div class="viewcode-block" id="SimDeep.evalutate_cluster_performance"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.evalutate_cluster_performance">[docs]</a>    <span class="k">def</span> <span class="nf">evalutate_cluster_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clustering attribute is defined as None. &#39;</span> \
                   <span class="s1">&#39; Cannot evaluate cluster performance&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span> <span class="o">==</span> <span class="s1">&#39;mixture&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bic_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">bic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">silhouette_score</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calinski_score</span> <span class="o">=</span> <span class="n">calinski_harabaz_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;silhouette score: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">silhouette_score</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;calinski-harabaz score: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calinski_score</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bic score: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bic_score</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_write_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_ids</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                      <span class="n">labels_proba</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">nbdays</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">isdead</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">path_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">fname</span> <span class="ow">or</span> <span class="n">path_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path_file</span><span class="p">:</span>
            <span class="n">path_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">.tsv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ids</span><span class="p">,</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">labels</span><span class="p">)):</span>
                <span class="n">suppl</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="k">if</span> <span class="n">labels_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">suppl</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels_proba</span><span class="p">[</span><span class="n">ids</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">nbdays</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">suppl</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nbdays</span><span class="p">[</span><span class="n">ids</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">isdead</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">suppl</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isdead</span><span class="p">[</span><span class="n">ids</span><span class="p">])</span>

                <span class="n">f_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\t</span><span class="si">{1}{2}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">suppl</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;file written: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_file</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_predict_survival_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix_array</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">activities_array</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matrix_array</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pretrained_model</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span> <span class="ow">is</span>  <span class="kc">None</span> <span class="ow">and</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">encoder_input_shape</span><span class="p">(</span><span class="n">key</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;matrix doesnt have the input dimension of the encoder&#39;</span>\
                              <span class="s1">&#39; returning None&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_predict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_autoencoders</span><span class="p">:</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_predict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

            <span class="n">activities_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">activities</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_node_ids_array</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span>

        <span class="k">return</span> <span class="n">hstack</span><span class="p">([</span><span class="n">activities_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                       <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>

<div class="viewcode-block" id="SimDeep.look_for_survival_nodes"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.look_for_survival_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">look_for_survival_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        detect nodes from the autoencoder significantly</span>
<span class="sd">        linked with survival through coxph regression</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder_array</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_train_array</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">matrix_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_train_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_predict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">matrix_train</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_autoencoders</span><span class="p">:</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_predict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">matrix_train</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">matrix_train</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_surv_analysis</span><span class="p">:</span>
                <span class="n">valid_node_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_look_for_nodes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">valid_node_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">matrix_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">valid_node_ids_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_node_ids</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activities_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">activities</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">valid_node_ids</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_omics</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering_omics</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span></div>

<div class="viewcode-block" id="SimDeep.look_for_prediction_nodes"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.look_for_prediction_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">look_for_prediction_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        detect nodes from the autoencoder that predict a</span>
<span class="sd">        high c-index scores using label from the retained test fold</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder_array</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">matrix_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_train_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_predict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">matrix_train</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_autoencoders</span><span class="p">:</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_predict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">matrix_train</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">matrix_train</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_surv_analysis</span><span class="p">:</span>
                <span class="n">valid_node_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_look_for_prediction_nodes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">valid_node_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">matrix_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pred_node_ids_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_node_ids</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">activities_pred_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">activities</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">valid_node_ids</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activities_for_pred_train</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_pred_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                                 <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span></div>

<div class="viewcode-block" id="SimDeep.compute_c_indexes_multiple_for_test_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.compute_c_indexes_multiple_for_test_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">compute_c_indexes_multiple_for_test_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return c-index using labels as predicat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">days</span><span class="p">,</span> <span class="n">dead</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">days_test</span><span class="p">,</span> <span class="n">dead_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival_test</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">activities_test</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_test_array</span><span class="p">:</span>
            <span class="n">node_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_node_ids_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_test_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">activities_test</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_predict</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">node_ids</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_autoencoders</span><span class="p">:</span>
                <span class="n">activities_test</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_predict</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">node_ids</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">activities_test</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_test_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">activities_test</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="n">activities_test</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">activities_train</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_pred_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                   <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_ref_array</span><span class="p">])</span>

        <span class="n">cindex</span> <span class="o">=</span> <span class="n">c_index_multiple</span><span class="p">(</span><span class="n">activities_train</span><span class="p">,</span> <span class="n">dead</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span>
                                  <span class="n">activities_test</span><span class="p">,</span> <span class="n">dead_test</span><span class="p">,</span> <span class="n">days_test</span><span class="p">,</span>
                                  <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index multiple for test dataset:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cindex</span></div>

<div class="viewcode-block" id="SimDeep.compute_c_indexes_multiple_for_test_fold_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.compute_c_indexes_multiple_for_test_fold_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">compute_c_indexes_multiple_for_test_fold_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return c-index using test-fold labels as predicat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">days</span><span class="p">,</span> <span class="n">dead</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">days_cv</span><span class="p">,</span> <span class="n">dead_cv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival_cv</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">activities_cv</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_cv_array</span><span class="p">:</span>
            <span class="n">node_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_node_ids_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">activities_cv</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_predict</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_cv_array</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">node_ids</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_autoencoders</span><span class="p">:</span>
                <span class="n">activities_cv</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_predict</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_cv_array</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">node_ids</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">activities_cv</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_cv_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">activities_cv</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="n">activities_cv</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">cindex</span> <span class="o">=</span> <span class="n">c_index_multiple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_for_pred_train</span><span class="p">,</span> <span class="n">dead</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span>
                                  <span class="n">activities_cv</span><span class="p">,</span> <span class="n">dead_cv</span><span class="p">,</span> <span class="n">days_cv</span><span class="p">,</span>
                                  <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index multiple for test fold dataset:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cindex</span></div>

    <span class="k">def</span> <span class="nf">_return_test_matrix_for_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activities</span><span class="p">,</span> <span class="n">matrix_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classification_method</span> <span class="o">==</span> <span class="s1">&#39;SURVIVAL_FEATURES&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activities</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">classification_method</span> <span class="o">==</span> <span class="s1">&#39;ALL_FEATURES&#39;</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reduce_and_stack_matrices</span><span class="p">(</span><span class="n">matrix_array</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">matrix</span>

    <span class="k">def</span> <span class="nf">_predict_test_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activities</span><span class="p">,</span> <span class="n">matrix_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">matrix_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_test_matrix_for_classification</span><span class="p">(</span>
            <span class="n">activities</span><span class="p">,</span> <span class="n">matrix_array</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier_test</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">matrix_test</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier_test</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">matrix_test</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span><span class="p">:</span>
            <span class="n">missing_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">missing_columns</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="p">,</span> <span class="mi">1</span><span class="p">))])</span>

    <span class="k">def</span> <span class="nf">_predict_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activities</span><span class="p">,</span> <span class="n">matrix_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">matrix_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_test_matrix_for_classification</span><span class="p">(</span>
            <span class="n">activities</span><span class="p">,</span> <span class="n">matrix_array</span><span class="p">)</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">matrix_test</span><span class="p">)</span>
        <span class="n">labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">matrix_test</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">labels_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span><span class="p">:</span>
            <span class="n">missing_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span> <span class="o">-</span> <span class="n">labels_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">missing_columns</span><span class="p">):</span>
                <span class="n">labels_proba</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span>
                    <span class="n">labels_proba</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">labels_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))])</span>

        <span class="k">return</span> <span class="n">labels</span><span class="p">,</span> <span class="n">labels_proba</span>

    <span class="k">def</span> <span class="nf">_predict_best_k_for_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">criterion</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_k</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">k_cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_array</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span> <span class="o">==</span> <span class="s1">&#39;mixture&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">k_cluster</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k_cluster</span><span class="p">)</span>

            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_eval_method</span> <span class="o">==</span> <span class="s1">&#39;bic&#39;</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">bic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_eval_method</span> <span class="o">==</span> <span class="s1">&#39;calinski&#39;</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">calinski_harabaz_score</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span><span class="p">,</span>
                    <span class="n">labels</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_eval_method</span> <span class="o">==</span> <span class="s1">&#39;silhouette&#39;</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">activities_train</span><span class="p">,</span>
                    <span class="n">labels</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obtained </span><span class="si">{2}</span><span class="s1">: </span><span class="si">{0}</span><span class="s1"> for k = </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">k_cluster</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">cluster_eval_method</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">criterion</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">criterion</span><span class="p">:</span>
                <span class="n">criterion</span><span class="p">,</span> <span class="n">best_k</span> <span class="o">=</span> <span class="n">score</span><span class="p">,</span> <span class="n">k_cluster</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">clustering_performance</span> <span class="o">=</span> <span class="n">criterion</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;best k: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_k</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span> <span class="o">==</span> <span class="s1">&#39;mixture&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">best_k</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">best_k</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_order_labels_according_to_survival</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Order cluster labels according to survival</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels_old</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">days</span><span class="p">,</span> <span class="n">dead</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_label_ordered_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">labels_old</span><span class="p">):</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">surv_median</span><span class="p">(</span><span class="n">dead</span><span class="p">[</span><span class="n">labels_old</span> <span class="o">==</span> <span class="n">label</span><span class="p">],</span>
                             <span class="n">days</span><span class="p">[</span><span class="n">labels_old</span> <span class="o">==</span> <span class="n">label</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_label_ordered_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span>

        <span class="n">label_ordered</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span>
                         <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_ordered_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_label_ordered_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">old_label</span><span class="p">:</span> <span class="n">new_label</span>
                      <span class="k">for</span> <span class="n">new_label</span><span class="p">,</span> <span class="n">old_label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_ordered</span><span class="p">)}</span>

        <span class="k">for</span> <span class="n">old_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label_ordered_dict</span><span class="p">:</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">labels_old</span> <span class="o">==</span> <span class="n">old_label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label_ordered_dict</span><span class="p">[</span><span class="n">old_label</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">labels</span>

    <span class="k">def</span> <span class="nf">_look_for_survival_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">activities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">survival</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">metadata_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">matrix_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_train_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_predict</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">matrix_train</span><span class="p">))</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_autoencoders</span><span class="p">:</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder_predict</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">matrix_train</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">activities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">matrix_train</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">activities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">survival</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="n">survival</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_selection_usage</span> <span class="o">==</span> <span class="s1">&#39;lasso&#39;</span><span class="p">:</span>
            <span class="n">cws</span> <span class="o">=</span> <span class="n">ClusterWithSurvival</span><span class="p">(</span>
                <span class="n">isdead</span><span class="o">=</span><span class="n">isdead</span><span class="p">,</span>
                <span class="n">nbdays</span><span class="o">=</span><span class="n">nbdays</span><span class="p">,</span>
                <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">cws</span><span class="o">.</span><span class="n">get_nonzero_features</span><span class="p">(</span><span class="n">activities</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_survival_features_parallel</span><span class="p">(</span>
                <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span> <span class="n">metadata_mat</span><span class="p">,</span> <span class="n">activities</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_survival_features_parallel</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span> <span class="n">metadata_mat</span><span class="p">,</span> <span class="n">activities</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isboosting</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_threads_coxph</span><span class="p">)</span>
            <span class="n">mapf</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mapf</span> <span class="o">=</span> <span class="nb">map</span>

        <span class="n">input_list</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">((</span><span class="n">node_id</span><span class="p">,</span>
                           <span class="n">activity</span><span class="p">,</span>
                           <span class="n">isdead</span><span class="p">,</span>
                           <span class="n">nbdays</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                           <span class="n">metadata_mat</span><span class="p">)</span>

                          <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">activity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">activities</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

        <span class="n">pvalue_list</span> <span class="o">=</span> <span class="n">mapf</span><span class="p">(</span><span class="n">_process_parallel_coxph</span><span class="p">,</span> <span class="n">input_list</span><span class="p">)</span>

        <span class="n">pvalue_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">pvalue_list</span><span class="p">))</span>
        <span class="n">pvalue_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">valid_node_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">node_id</span> <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">pvalue</span> <span class="ow">in</span> <span class="n">pvalue_list</span>
                          <span class="k">if</span> <span class="n">pvalue</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_thres</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of components linked to survival found:</span><span class="si">{0}</span><span class="s1"> for key </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">valid_node_ids</span><span class="p">),</span> <span class="n">key</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">valid_node_ids</span>

    <span class="k">def</span> <span class="nf">_look_for_prediction_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">nbdays_cv</span><span class="p">,</span> <span class="n">isdead_cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival_cv</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">matrix_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_train_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">matrix_cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_cv_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">activities_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_predict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">matrix_train</span><span class="p">)</span>
            <span class="n">activities_cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_predict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">matrix_cv</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_autoencoders</span><span class="p">:</span>
            <span class="n">activities_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_predict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">matrix_train</span><span class="p">)</span>
            <span class="n">activities_cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_predict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">matrix_cv</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">activities_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="n">matrix_train</span><span class="p">)</span>
            <span class="n">activities_cv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="n">matrix_cv</span><span class="p">)</span>

        <span class="n">input_list</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">((</span><span class="n">node_id</span><span class="p">,</span>
                           <span class="n">activities_train</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">node_id</span><span class="p">],</span> <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span>
                           <span class="n">activities_cv</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">node_id</span><span class="p">],</span> <span class="n">isdead_cv</span><span class="p">,</span> <span class="n">nbdays_cv</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">activities_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">score_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">_process_parallel_cindex</span><span class="p">,</span> <span class="n">input_list</span><span class="p">)</span>

        <span class="n">score_list</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">score_list</span><span class="p">)</span>
        <span class="n">score_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">valid_node_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">node_id</span> <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">cindex</span> <span class="ow">in</span> <span class="n">score_list</span>
                               <span class="k">if</span> <span class="n">cindex</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cindex_thres</span><span class="p">]</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span> <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">score_list</span>
                  <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cindex_thres</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of components with a high prediction score:</span><span class="si">{0}</span><span class="s1"> for key </span><span class="si">{1}</span><span class="s1">&#39;</span>\
                  <span class="s1">&#39; </span><span class="se">\n\t</span><span class="s1"> mean: </span><span class="si">{2}</span><span class="s1"> std: </span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                      <span class="nb">len</span><span class="p">(</span><span class="n">valid_node_ids</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">scores</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">valid_node_ids</span>

<div class="viewcode-block" id="SimDeep.compute_c_indexes_for_full_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.compute_c_indexes_for_full_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">compute_c_indexes_for_full_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return c-index using labels as predicat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">days</span><span class="p">,</span> <span class="n">dead</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">days_full</span><span class="p">,</span> <span class="n">dead_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival_full</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cindex</span> <span class="o">=</span> <span class="n">c_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">dead</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">,</span> <span class="n">dead_full</span><span class="p">,</span> <span class="n">days_full</span><span class="p">,</span>
                             <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception while computing the c-index: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">cindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index for full dataset:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cindex</span></div>

<div class="viewcode-block" id="SimDeep.compute_c_indexes_for_training_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.compute_c_indexes_for_training_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">compute_c_indexes_for_training_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return c-index using labels as predicat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">days</span><span class="p">,</span> <span class="n">dead</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cindex</span> <span class="o">=</span> <span class="n">c_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">dead</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">dead</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span>
                             <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception while computing the c-index: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">cindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index for training dataset:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cindex</span></div>

<div class="viewcode-block" id="SimDeep.compute_c_indexes_for_test_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.compute_c_indexes_for_test_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">compute_c_indexes_for_test_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return c-index using labels as predicat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">days</span><span class="p">,</span> <span class="n">dead</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">days_test</span><span class="p">,</span> <span class="n">dead_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival_test</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cindex</span> <span class="o">=</span> <span class="n">c_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">dead</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">dead_test</span><span class="p">,</span> <span class="n">days_test</span><span class="p">,</span>
                             <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception while computing the c-index: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">cindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index for test dataset:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cindex</span></div>

<div class="viewcode-block" id="SimDeep.compute_c_indexes_for_test_fold_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.compute_c_indexes_for_test_fold_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">compute_c_indexes_for_test_fold_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return c-index using labels as predicat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">days</span><span class="p">,</span> <span class="n">dead</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">days_cv</span><span class="p">,</span> <span class="n">dead_cv</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival_cv</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cindex</span> <span class="o">=</span>  <span class="n">c_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">dead</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">cv_labels</span><span class="p">,</span> <span class="n">dead_cv</span><span class="p">,</span> <span class="n">days_cv</span><span class="p">,</span>
                              <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception while computing the c-index: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">cindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index for test fold dataset:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cindex</span></div>

<div class="viewcode-block" id="SimDeep.predict_nodes_activities"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.predict_nodes_activities">[docs]</a>    <span class="k">def</span> <span class="nf">predict_nodes_activities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">activities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">matrix_array</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_node_ids_array</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">node_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_node_ids_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">activities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">embedding_predict</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">matrix_array</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">node_ids</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">activities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">encoder_predict</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">matrix_array</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">node_ids</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hstack</span><span class="p">(</span><span class="n">activities</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimDeep.plot_kernel_for_test_sets"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.plot_kernel_for_test_sets">[docs]</a>    <span class="k">def</span> <span class="nf">plot_kernel_for_test_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                  <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">labels_proba</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">test_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">test_labels_proba</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">define_as_main_kernel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">use_main_kernel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">activities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">activities_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">simdeep.plot_utils</span> <span class="kn">import</span> <span class="n">plot_kernel_plots</span>

        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span>

        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span>

        <span class="k">if</span> <span class="n">labels_proba</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span>

        <span class="k">if</span> <span class="n">test_labels_proba</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span>

        <span class="k">if</span> <span class="n">test_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span>

        <span class="k">if</span> <span class="n">test_labels_proba</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span>

        <span class="n">test_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span>
        <span class="n">train_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalization</span>
        <span class="n">train_norm</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">train_norm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">train_norm</span> <span class="k">if</span> <span class="n">train_norm</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>

        <span class="n">is_same_normalization</span> <span class="o">=</span> <span class="n">train_norm</span> <span class="o">==</span> <span class="n">test_norm</span>
        <span class="n">is_filled_with_zero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">fill_unkown_feature_with_0</span>

        <span class="k">if</span> <span class="n">activities</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">activities_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_same_normalization</span> <span class="ow">and</span> <span class="n">is_filled_with_zero</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt; Cannot plot survival KDE plot&#39;</span> \
                      <span class="s1">&#39; Different normalisation used for test set &lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">activities</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_array</span><span class="p">[</span><span class="n">omic</span><span class="p">]</span>
                                 <span class="k">for</span> <span class="n">omic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_omic_list</span><span class="p">])</span>
            <span class="n">activities_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activities_test</span>

        <span class="k">if</span> <span class="n">define_as_main_kernel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_main_kernel</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;activities&#39;</span><span class="p">:</span> <span class="n">activities_test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                 <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">test_labels</span><span class="o">.</span><span class="n">copy</span><span class="p">()}</span>

        <span class="k">if</span> <span class="n">use_main_kernel</span><span class="p">:</span>
            <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_kernel</span><span class="p">[</span><span class="s1">&#39;activities&#39;</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_kernel</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>

        <span class="n">html_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}{2}</span><span class="s1">_test_kdeplot.html&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span>
            <span class="n">key</span><span class="p">)</span>

        <span class="n">plot_kernel_plots</span><span class="p">(</span>
            <span class="n">test_labels</span><span class="o">=</span><span class="n">test_labels</span><span class="p">,</span>
            <span class="n">test_labels_proba</span><span class="o">=</span><span class="n">test_labels_proba</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">activities</span><span class="o">=</span><span class="n">activities</span><span class="p">,</span>
            <span class="n">activities_test</span><span class="o">=</span><span class="n">activities_test</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">path_html</span><span class="o">=</span><span class="n">html_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimDeep.plot_supervised_kernel_for_test_sets"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_analysis.SimDeep.plot_supervised_kernel_for_test_sets">[docs]</a>    <span class="k">def</span> <span class="nf">plot_supervised_kernel_for_test_sets</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">labels_proba</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">use_main_kernel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">test_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">test_labels_proba</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">define_as_main_kernel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span>

        <span class="k">if</span> <span class="n">labels_proba</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_proba</span>

        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span>

        <span class="n">activities</span><span class="p">,</span> <span class="n">activities_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_kde_matrix</span><span class="p">(</span>
            <span class="n">labels_proba</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>

        <span class="n">key</span> <span class="o">+=</span> <span class="s1">&#39;_supervised&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_kernel_for_test_sets</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                                       <span class="n">labels_proba</span><span class="o">=</span><span class="n">labels_proba</span><span class="p">,</span>
                                       <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                                       <span class="n">activities</span><span class="o">=</span><span class="n">activities</span><span class="p">,</span>
                                       <span class="n">activities_test</span><span class="o">=</span><span class="n">activities_test</span><span class="p">,</span>
                                       <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                       <span class="n">use_main_kernel</span><span class="o">=</span><span class="n">use_main_kernel</span><span class="p">,</span>
                                       <span class="n">test_labels</span><span class="o">=</span><span class="n">test_labels</span><span class="p">,</span>
                                       <span class="n">test_labels_proba</span><span class="o">=</span><span class="n">test_labels_proba</span><span class="p">,</span>
                                       <span class="n">define_as_main_kernel</span><span class="o">=</span><span class="n">define_as_main_kernel</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_autoencoder_for_kernel_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels_proba</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">autoencoder</span> <span class="o">=</span> <span class="n">DeepBase</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                               <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                               <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

        <span class="n">autoencoder</span><span class="o">.</span><span class="n">matrix_train_array</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">matrix_ref_array</span>
        <span class="n">autoencoder</span><span class="o">.</span><span class="n">construct_supervized_network</span><span class="p">(</span><span class="n">labels_proba</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_for_kde_plot_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">encoder_array</span>

    <span class="k">def</span> <span class="nf">_predict_kde_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels_proba</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matrix_ref_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">matrix_test_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">encoder_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span><span class="p">)</span>
        <span class="n">encoder_key</span> <span class="o">=</span> <span class="s1">&#39;omic:</span><span class="si">{0}</span><span class="s1"> normalisation: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_omic_list</span><span class="p">,</span>
            <span class="n">encoder_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">encoder_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_for_kde_plot_dict</span> <span class="ow">or</span> \
           <span class="ow">not</span> <span class="n">dataset</span><span class="o">.</span><span class="n">fill_unkown_feature_with_0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_autoencoder_for_kernel_plot</span><span class="p">(</span>
                <span class="n">labels_proba</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">encoder_key</span><span class="p">)</span>

        <span class="n">encoder_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_for_kde_plot_dict</span><span class="p">[</span><span class="n">encoder_key</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_usage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;new-features&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="n">dataset</span><span class="o">.</span><span class="n">metadata_mat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">metadata_mat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">encoder_array</span><span class="p">:</span>
            <span class="n">matrix_ref</span> <span class="o">=</span> <span class="n">encoder_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">matrix_ref_array</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">matrix_test</span> <span class="o">=</span> <span class="n">encoder_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">matrix_test_array</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

            <span class="n">survival_node_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_look_for_survival_nodes</span><span class="p">(</span>
                <span class="n">activities</span><span class="o">=</span><span class="n">matrix_ref</span><span class="p">,</span> <span class="n">survival</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="p">,</span>
                <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">survival_node_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">matrix_ref</span> <span class="o">=</span> <span class="n">matrix_ref</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">survival_node_ids</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">matrix_test</span> <span class="o">=</span> <span class="n">matrix_test</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">survival_node_ids</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;not enough survival nodes to construct kernel for key: </span><span class="si">{0}</span><span class="s1">&#39;</span> \
                      <span class="s1">&#39;skipping the </span><span class="si">{0}</span><span class="s1"> matrix&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">matrix_ref_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matrix_ref</span><span class="p">)</span>
            <span class="n">matrix_test_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matrix_test</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">matrix_ref_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;matrix_ref_list / matrix_test_list empty!&#39;</span> \
                  <span class="s1">&#39;take the last OMIC (</span><span class="si">{0}</span><span class="s1">) matrix as ref&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">matrix_ref_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matrix_ref</span><span class="p">)</span>
            <span class="n">matrix_test_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matrix_test</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hstack</span><span class="p">(</span><span class="n">matrix_ref_list</span><span class="p">),</span> <span class="n">hstack</span><span class="p">(</span><span class="n">matrix_test_list</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_probas_for_full_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return sample and proba</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sample_ids_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_get_pvalues_and_pvalues_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_pvalue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_pvalue_proba</span>

    <span class="k">def</span> <span class="nf">_get_from_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_attibute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_partial_fit_model_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_training_dataset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;only one class!&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_pvalue</span> <span class="o">&gt;</span> <span class="n">MODEL_THRES</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;pvalue: </span><span class="si">{0}</span><span class="s1"> not significant!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_pvalue</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;model with random state:</span><span class="si">{1}</span><span class="s1"> didn</span><span class="se">\&#39;</span><span class="s1">t converge:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;model with random state:</span><span class="si">{0}</span><span class="s1"> fitted&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predict_labels_on_test_fold</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_labels_on_full_dataset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evalutate_cluster_performance</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span>

    <span class="k">def</span> <span class="nf">_partial_fit_model_with_pretrained_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_on_pretrained_label_file</span><span class="p">(</span><span class="n">labels_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predict_labels_on_test_fold</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_labels_on_full_dataset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evalutate_cluster_performance</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_fitted</span>

    <span class="k">def</span> <span class="nf">_predict_new_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">tsv_dict</span><span class="p">,</span>
                             <span class="n">path_survival_file</span><span class="p">,</span>
                             <span class="n">normalization</span><span class="p">,</span>
                             <span class="n">survival_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">metadata_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_new_test_dataset</span><span class="p">(</span>
            <span class="n">tsv_dict</span><span class="o">=</span><span class="n">tsv_dict</span><span class="p">,</span>
            <span class="n">path_survival_file</span><span class="o">=</span><span class="n">path_survival_file</span><span class="p">,</span>
            <span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span><span class="p">,</span>
            <span class="n">survival_flag</span><span class="o">=</span><span class="n">survival_flag</span><span class="p">,</span>
            <span class="n">metadata_file</span><span class="o">=</span><span class="n">metadata_file</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predict_labels_on_test_dataset</span><span class="p">()</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, Olivier Poirion.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>