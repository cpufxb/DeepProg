

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>simdeep.simdeep_boosting &mdash; DeepProg  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> DeepProg
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Tutorial: Simple DeepProg model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage_ensemble.html">Tutorial: Ensemble of DeepProg model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage_advanced.html">Tutorial: Advanced usage of DeepProg model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../case_study.html">Case study: Analyzing TCGA HCC dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage_tuning.html">Tutorial: Tuning DeepProg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/simdeep.html">simdeep package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DeepProg</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>simdeep.simdeep_boosting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for simdeep.simdeep_boosting</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">simdeep.simdeep_analysis</span> <span class="kn">import</span> <span class="n">SimDeep</span>
<span class="kn">from</span> <span class="nn">simdeep.extract_data</span> <span class="kn">import</span> <span class="n">LoadData</span>

<span class="kn">from</span> <span class="nn">simdeep.coxph_from_r</span> <span class="kn">import</span> <span class="n">coxph</span>
<span class="kn">from</span> <span class="nn">simdeep.coxph_from_r</span> <span class="kn">import</span> <span class="n">c_index</span>
<span class="kn">from</span> <span class="nn">simdeep.coxph_from_r</span> <span class="kn">import</span> <span class="n">c_index_multiple</span>
<span class="kn">from</span> <span class="nn">simdeep.coxph_from_r</span> <span class="kn">import</span> <span class="n">NALogicalType</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="c1"># from sklearn.preprocessing import OneHotEncoder</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gmean</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">adjusted_rand_score</span>

<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">PROJECT_NAME</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">PATH_RESULTS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">NB_THREADS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">NB_ITER</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">NB_FOLDS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CLASS_SELECTION</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">NB_CLUSTERS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">NORMALIZATION</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">EPOCHS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">NEW_DIM</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">NB_SELECTED_FEATURES</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">PVALUE_THRESHOLD</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CLUSTER_METHOD</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CLASSIFICATION_METHOD</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">TRAINING_TSV</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">SURVIVAL_TSV</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">PATH_DATA</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">SURVIVAL_FLAG</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">NODES_SELECTION</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CINDEX_THRESHOLD</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">USE_AUTOENCODERS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">FEATURE_SURV_ANALYSIS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">CLUSTERING_OMICS</span>

<span class="c1"># Parameter for autoencoder</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">LEVEL_DIMS_IN</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">LEVEL_DIMS_OUT</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">LOSS</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">OPTIMIZER</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">ACT_REG</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">W_REG</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">DROPOUT</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">ACTIVATION</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">PATH_TO_SAVE_MODEL</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">DATA_SPLIT</span>
<span class="kn">from</span> <span class="nn">simdeep.config</span> <span class="kn">import</span> <span class="n">MODEL_THRES</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>

<span class="kn">from</span> <span class="nn">simdeep.deepmodel_base</span> <span class="kn">import</span> <span class="n">DeepBase</span>

<span class="kn">import</span> <span class="nn">simplejson</span>

<span class="kn">from</span> <span class="nn">distutils.dir_util</span> <span class="kn">import</span> <span class="n">mkpath</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isdir</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">mkdir</span>

<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>

<span class="kn">import</span> <span class="nn">gc</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>

<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">hstack</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">vstack</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">simdeep.survival_utils</span> <span class="kn">import</span> \
    <span class="n">_process_parallel_feature_importance_per_cluster</span>
<span class="kn">from</span> <span class="nn">simdeep.survival_utils</span> <span class="kn">import</span> \
    <span class="n">_process_parallel_survival_feature_importance_per_cluster</span>



<div class="viewcode-block" id="SimDeepBoosting"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting">[docs]</a><span class="k">class</span> <span class="nc">SimDeepBoosting</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instanciate a new DeepProg Boosting instance.</span>
<span class="sd">    The default parameters are defined in the config.py file</span>

<span class="sd">    Parameters:</span>
<span class="sd">            :nb_it: Number of models to construct</span>
<span class="sd">            :do_KM_plot: Plot Kaplan-Meier (default: True)</span>
<span class="sd">            :distribute: Distribute DeepProg using ray (default:  False)</span>
<span class="sd">            :nb_threads: Number of python threads to use to compute parallel Cox-PH</span>
<span class="sd">            :class_selection: Consensus score to agglomerate DeepProg Instance {&#39;mean&#39;, &#39;max&#39;, &#39;weighted_mean&#39;, &#39;weighted_max&#39;} (default: &#39;mean&#39;)</span>
<span class="sd">            :model_thres: Cox-PH p-value threshold to reject a model for DeepProg Boosting module</span>
<span class="sd">            :verbose: Verobosity (Default: True)</span>
<span class="sd">            :seed: Seed defining the  random split of the training dataset (Default: None).</span>
<span class="sd">            :project_name: Project name used to save files</span>
<span class="sd">            :use_autoencoders: Use autoencoder steps to embed the data (default: True)</span>
<span class="sd">            :feature_surv_analysis: Use individual survival feature detection to filter out features (default: True)</span>
<span class="sd">            :split_n_fold: For each instance, the original dataset is split in folds and one fold is left</span>
<span class="sd">            :path_results: Path to create a result folder</span>
<span class="sd">            :nb_clusters: Number of clusters to use</span>
<span class="sd">            :epochs: Number of epochs</span>
<span class="sd">            :normalization: Normalisation procedure to use. See config.py file for details</span>
<span class="sd">            :nb_selected_features: Number of top features selected for classification</span>
<span class="sd">            :cluster_method: Clustering method. possible choice: [&#39;mixture&#39;, &#39;kmeans&#39;, &#39;coxPH&#39;] or class instance having fit and fit_proba attributes</span>
<span class="sd">            :pvalue_thres: Threshold for survival significance to set a node as valid</span>
<span class="sd">            :classification_method: Possible choice: {&#39;ALL_FEATURES&#39;, &#39;SURVIVAL_FEATURES&#39;} (default: &#39;ALL_FEATURES&#39;)</span>
<span class="sd">            :new_dim: Size of the new embedding</span>
<span class="sd">            :training_tsv: Input matrix files</span>
<span class="sd">            :survival_tsv: Input surival file</span>
<span class="sd">            :survival_flag: Survival flag to use</span>
<span class="sd">            :path_data: Path of the input file</span>
<span class="sd">            :level_dims_in: Autoencoder node layers before the middle layer (default: [])</span>
<span class="sd">            :level_dims_out: Autoencoder node layers after the middle layer (default: [])</span>
<span class="sd">            :loss: Loss function to minimize (default: &#39;binary_crossentropy&#39;)</span>
<span class="sd">            :optimizer: Optimizer (default: adam)</span>
<span class="sd">            :act_reg: L2 Regularization constant on the node activity (default: False)</span>
<span class="sd">            :w_reg: L1 Regularization constant on the weight (default: False)</span>
<span class="sd">            :dropout: Percentage of edges being dropout at each training iteration (None for no dropout) (default: 0.5)</span>
<span class="sd">            :data_split: Fraction of the dataset to be used as test set when building the autoencoder (default: None)</span>
<span class="sd">            :node_selection: possible choice: {&#39;Cox-PH&#39;, &#39;C-index&#39;} (default: Cox-PH)</span>
<span class="sd">            :cindex_thres: Valid if &#39;c-index&#39; is chosen (default: 0.65)</span>
<span class="sd">            :activation: Activation function (default: &#39;tanh&#39;)</span>
<span class="sd">            :clustering_omics: Which omics to use for clustering. If empty, then all the available omics will be used (default [] =&gt; all)</span>
<span class="sd">            :path_to_save_model: path to save the model</span>
<span class="sd">            :metadata_usage: Meta data usage with survival models (if metadata_tsv provided as argument to the dataset). Possible choice are [None, False, &#39;labels&#39;, &#39;new-features&#39;, &#39;all&#39;, True] (True is the same as all)</span>
<span class="sd">            :subset_training_with_meta: Use a metadata key-value dict {meta_key:value} to subset the training sets</span>
<span class="sd">            :alternative_embedding: alternative external embedding to use instead of building autoencoders (default None)</span>
<span class="sd">            :kwargs_alternative_embedding: parameters for external embedding fitting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">nb_it</span><span class="o">=</span><span class="n">NB_ITER</span><span class="p">,</span>
                 <span class="n">do_KM_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">distribute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">nb_threads</span><span class="o">=</span><span class="n">NB_THREADS</span><span class="p">,</span>
                 <span class="n">class_selection</span><span class="o">=</span><span class="n">CLASS_SELECTION</span><span class="p">,</span>
                 <span class="n">model_thres</span><span class="o">=</span><span class="n">MODEL_THRES</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">project_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_boosting&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PROJECT_NAME</span><span class="p">),</span>
                 <span class="n">use_autoencoders</span><span class="o">=</span><span class="n">USE_AUTOENCODERS</span><span class="p">,</span>
                 <span class="n">feature_surv_analysis</span><span class="o">=</span><span class="n">FEATURE_SURV_ANALYSIS</span><span class="p">,</span>
                 <span class="n">split_n_fold</span><span class="o">=</span><span class="n">NB_FOLDS</span><span class="p">,</span>
                 <span class="n">path_results</span><span class="o">=</span><span class="n">PATH_RESULTS</span><span class="p">,</span>
                 <span class="n">nb_clusters</span><span class="o">=</span><span class="n">NB_CLUSTERS</span><span class="p">,</span>
                 <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">,</span>
                 <span class="n">normalization</span><span class="o">=</span><span class="n">NORMALIZATION</span><span class="p">,</span>
                 <span class="n">nb_selected_features</span><span class="o">=</span><span class="n">NB_SELECTED_FEATURES</span><span class="p">,</span>
                 <span class="n">cluster_method</span><span class="o">=</span><span class="n">CLUSTER_METHOD</span><span class="p">,</span>
                 <span class="n">pvalue_thres</span><span class="o">=</span><span class="n">PVALUE_THRESHOLD</span><span class="p">,</span>
                 <span class="n">classification_method</span><span class="o">=</span><span class="n">CLASSIFICATION_METHOD</span><span class="p">,</span>
                 <span class="n">new_dim</span><span class="o">=</span><span class="n">NEW_DIM</span><span class="p">,</span>
                 <span class="n">training_tsv</span><span class="o">=</span><span class="n">TRAINING_TSV</span><span class="p">,</span>
                 <span class="n">metadata_usage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">survival_tsv</span><span class="o">=</span><span class="n">SURVIVAL_TSV</span><span class="p">,</span>
                 <span class="n">metadata_tsv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">subset_training_with_meta</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">survival_flag</span><span class="o">=</span><span class="n">SURVIVAL_FLAG</span><span class="p">,</span>
                 <span class="n">path_data</span><span class="o">=</span><span class="n">PATH_DATA</span><span class="p">,</span>
                 <span class="n">level_dims_in</span><span class="o">=</span><span class="n">LEVEL_DIMS_IN</span><span class="p">,</span>
                 <span class="n">level_dims_out</span><span class="o">=</span><span class="n">LEVEL_DIMS_OUT</span><span class="p">,</span>
                 <span class="n">loss</span><span class="o">=</span><span class="n">LOSS</span><span class="p">,</span>
                 <span class="n">optimizer</span><span class="o">=</span><span class="n">OPTIMIZER</span><span class="p">,</span>
                 <span class="n">act_reg</span><span class="o">=</span><span class="n">ACT_REG</span><span class="p">,</span>
                 <span class="n">w_reg</span><span class="o">=</span><span class="n">W_REG</span><span class="p">,</span>
                 <span class="n">dropout</span><span class="o">=</span><span class="n">DROPOUT</span><span class="p">,</span>
                 <span class="n">data_split</span><span class="o">=</span><span class="n">DATA_SPLIT</span><span class="p">,</span>
                 <span class="n">node_selection</span><span class="o">=</span><span class="n">NODES_SELECTION</span><span class="p">,</span>
                 <span class="n">cindex_thres</span><span class="o">=</span><span class="n">CINDEX_THRESHOLD</span><span class="p">,</span>
                 <span class="n">activation</span><span class="o">=</span><span class="n">ACTIVATION</span><span class="p">,</span>
                 <span class="n">clustering_omics</span><span class="o">=</span><span class="n">CLUSTERING_OMICS</span><span class="p">,</span>
                 <span class="n">path_to_save_model</span><span class="o">=</span><span class="n">PATH_TO_SAVE_MODEL</span><span class="p">,</span>
                 <span class="n">feature_selection_usage</span><span class="o">=</span><span class="s1">&#39;individual&#39;</span><span class="p">,</span>
                 <span class="n">alternative_embedding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">kwargs_alternative_embedding</span><span class="o">=</span><span class="p">{},</span>
                 <span class="o">**</span><span class="n">additional_dataset_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">class_selection</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;weighted_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;weighted_max&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_selection</span> <span class="o">=</span> <span class="n">class_selection</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_instance_weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distribute</span> <span class="o">=</span> <span class="n">distribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_thres</span> <span class="o">=</span> <span class="n">model_thres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_threads</span> <span class="o">=</span> <span class="n">nb_threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_KM_plot</span> <span class="o">=</span> <span class="n">do_KM_plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="n">project_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_tsv</span> <span class="o">=</span> <span class="n">training_tsv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">survival_tsv</span> <span class="o">=</span> <span class="n">survival_tsv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">survival_flag</span> <span class="o">=</span> <span class="n">survival_flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_data</span> <span class="o">=</span> <span class="n">path_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cindex_thres</span> <span class="o">=</span> <span class="n">cindex_thres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_selection</span> <span class="o">=</span> <span class="n">node_selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clustering_omics</span> <span class="o">=</span> <span class="n">clustering_omics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_tsv</span> <span class="o">=</span> <span class="n">metadata_tsv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_usage</span> <span class="o">=</span> <span class="n">metadata_usage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_selection_usage</span> <span class="o">=</span> <span class="n">feature_selection_usage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subset_training_with_meta</span> <span class="o">=</span> <span class="n">subset_training_with_meta</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_mat_full</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span> <span class="o">=</span> <span class="n">cluster_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_autoencoders</span> <span class="o">=</span> <span class="n">use_autoencoders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_surv_analysis</span> <span class="o">=</span> <span class="n">feature_surv_analysis</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_for_kde_plot_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kde_survival_node_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kde_train_matrices</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mkpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot find or create the current result path: </span><span class="si">{0}</span><span class="s1">&#39;</span> \
                      <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> consider changing it as option&#39;</span> \
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_tsv_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_survival_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cv_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_labels_proba</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_labels_dicts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">survival_full</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids_full</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">survival_feature_scores_per_cluster</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pretrained_fit</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span> <span class="o">=</span> <span class="n">alternative_embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs_alternative_embedding</span> <span class="o">=</span> <span class="n">kwargs_alternative_embedding</span>

        <span class="c1">######## deepprog instance parameters ########</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span> <span class="o">=</span> <span class="n">nb_clusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalization</span> <span class="o">=</span> <span class="n">normalization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_dim</span> <span class="o">=</span> <span class="n">new_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_selected_features</span> <span class="o">=</span> <span class="n">nb_selected_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_thres</span> <span class="o">=</span> <span class="n">pvalue_thres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span> <span class="o">=</span> <span class="n">cluster_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cindex_test_folds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classification_method</span> <span class="o">=</span> <span class="n">classification_method</span>
        <span class="c1">##############################################</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matrix_with_cv_array</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">autoencoder_parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;epochs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span>
            <span class="s1">&#39;new_dim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_dim</span><span class="p">,</span>
            <span class="s1">&#39;level_dims_in&#39;</span><span class="p">:</span> <span class="n">level_dims_in</span><span class="p">,</span>
            <span class="s1">&#39;level_dims_out&#39;</span><span class="p">:</span> <span class="n">level_dims_out</span><span class="p">,</span>
            <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span>
            <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="p">,</span>
            <span class="s1">&#39;act_reg&#39;</span><span class="p">:</span> <span class="n">act_reg</span><span class="p">,</span>
            <span class="s1">&#39;w_reg&#39;</span><span class="p">:</span> <span class="n">w_reg</span><span class="p">,</span>
            <span class="s1">&#39;dropout&#39;</span><span class="p">:</span> <span class="n">dropout</span><span class="p">,</span>
            <span class="s1">&#39;data_split&#39;</span><span class="p">:</span> <span class="n">data_split</span><span class="p">,</span>
            <span class="s1">&#39;activation&#39;</span><span class="p">:</span> <span class="n">activation</span><span class="p">,</span>
            <span class="s1">&#39;path_to_save_model&#39;</span><span class="p">:</span> <span class="n">path_to_save_model</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">arg</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">autoencoder_parameters</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;nb_it&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;normalization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;nb clusters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_clusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;survival_tsv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_tsv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;metadata_tsv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_tsv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;subset_training_with_meta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subset_training_with_meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;training_tsv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_tsv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;path_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_data</span>

        <span class="n">additional_dataset_args</span><span class="p">[</span><span class="s1">&#39;survival_tsv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_tsv</span>
        <span class="n">additional_dataset_args</span><span class="p">[</span><span class="s1">&#39;metadata_tsv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_tsv</span>
        <span class="n">additional_dataset_args</span><span class="p">[</span><span class="s1">&#39;subset_training_with_meta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subset_training_with_meta</span>
        <span class="n">additional_dataset_args</span><span class="p">[</span><span class="s1">&#39;training_tsv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_tsv</span>
        <span class="n">additional_dataset_args</span><span class="p">[</span><span class="s1">&#39;path_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_data</span>
        <span class="n">additional_dataset_args</span><span class="p">[</span><span class="s1">&#39;survival_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_flag</span>

        <span class="k">if</span> <span class="s1">&#39;fill_unkown_feature_with_0&#39;</span> <span class="ow">in</span> <span class="n">additional_dataset_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;fill_unkown_feature_with_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_dataset_args</span><span class="p">[</span>
                <span class="s1">&#39;fill_unkown_feature_with_0&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ray</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_datasets</span><span class="p">(</span><span class="n">nb_it</span><span class="p">,</span> <span class="n">split_n_fold</span><span class="p">,</span>
                            <span class="n">autoencoder_parameters</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">additional_dataset_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb_it</span><span class="p">,</span> <span class="n">split_n_fold</span><span class="p">,</span>
                       <span class="n">autoencoder_parameters</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">additional_dataset_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">)</span>

        <span class="n">max_seed</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">min_seed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">&gt;</span> <span class="n">max_seed</span><span class="p">:</span>
            <span class="n">min_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">-</span> <span class="n">max_seed</span>
            <span class="n">max_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span>

        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">random_states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">min_seed</span><span class="p">,</span> <span class="n">max_seed</span><span class="p">,</span> <span class="n">nb_it</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">split_n_fold</span> <span class="o">=</span> <span class="n">split_n_fold</span>

        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_it</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_n_fold</span><span class="p">:</span>
                <span class="n">split</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">split_n_fold</span><span class="p">,</span>
                              <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_states</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">split</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">autoencoder_parameters</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_states</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>

            <span class="n">dataset</span> <span class="o">=</span> <span class="n">LoadData</span><span class="p">(</span><span class="n">cross_validation_instance</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">normalization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalization</span><span class="p">,</span>
                               <span class="n">_autoencoder_parameters</span><span class="o">=</span><span class="n">autoencoder_parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                               <span class="o">**</span><span class="n">additional_dataset_args</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">model</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Exception </span><span class="si">{0}</span><span class="s1"> from garbage collector. continuing... &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_from_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribute</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fname</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">_from_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribute</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fname</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_model_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">atname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribute</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_get_attibute</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">atname</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_attibute</span><span class="p">(</span><span class="n">atname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_models_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribute</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="n">_get_attibute</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">atname</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">_get_attibute</span><span class="p">(</span><span class="n">atname</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">atname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribute</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_get_from_dataset</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">atname</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_from_dataset</span><span class="p">(</span><span class="n">atname</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_do_class_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_selection</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="k">return</span>  <span class="n">_highest_proba</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_selection</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_mean_proba</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_selection</span> <span class="o">==</span> <span class="s1">&#39;weighted_mean&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_weighted_mean</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_selection</span> <span class="o">==</span> <span class="s1">&#39;weighted_max&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_weighted_max</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="SimDeepBoosting.partial_fit"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.partial_fit">[docs]</a>    <span class="k">def</span> <span class="nf">partial_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimDeepBoosting.fit_on_pretrained_label_file"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.fit_on_pretrained_label_file">[docs]</a>    <span class="k">def</span> <span class="nf">fit_on_pretrained_label_file</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">labels_files</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">labels_files_folder</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">file_name_regex</span><span class="o">=</span><span class="s2">&quot;*.tsv&quot;</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        fit a deepprog simdeep models without training autoencoders but using isntead  ID-&gt;labels files (one for each model instance)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">((</span><span class="n">labels_files</span><span class="p">),</span> <span class="nb">list</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">labels_files</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">labels_files_folder</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s1">&#39;## Error with fit_on_pretrained_label_file: &#39;</span> \
                <span class="s1">&#39; either labels_files or labels_files_folder should be non empty&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">labels_files</span><span class="p">:</span>
            <span class="n">labels_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels_files_folder</span><span class="p">,</span>
                                                 <span class="n">file_name_regex</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">labels_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;## Error: labels_files empty&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
            <span class="n">pretrained_labels_files</span><span class="o">=</span><span class="n">labels_files</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimDeepBoosting.fit"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pretrained_labels_files</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if pretrained_labels_files, is given, the models are constructed using these labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pretrained_labels_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pretrained_fit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pretrained_fit</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_distributed</span><span class="p">(</span>
                <span class="n">pretrained_labels_files</span><span class="o">=</span><span class="n">pretrained_labels_files</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">pretrained_labels_files</span><span class="o">=</span><span class="n">pretrained_labels_files</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_fit_distributed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretrained_labels_files</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fit models...&#39;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">simdeep.simdeep_distributed</span> <span class="kn">import</span> <span class="n">SimDeepDistributed</span>
        <span class="kn">import</span> <span class="nn">ray</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">ray</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ray</span> <span class="o">=</span> <span class="n">ray</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">SimDeepDistributed</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
                <span class="n">nb_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span><span class="p">,</span>
                <span class="n">nb_selected_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_selected_features</span><span class="p">,</span>
                <span class="n">pvalue_thres</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvalue_thres</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                <span class="n">load_existing_models</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">_isboosting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">do_KM_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">cluster_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span><span class="p">,</span>
                <span class="n">clustering_omics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clustering_omics</span><span class="p">,</span>
                <span class="n">use_autoencoders</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_autoencoders</span><span class="p">,</span>
                <span class="n">feature_surv_analysis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_surv_analysis</span><span class="p">,</span>
                <span class="n">path_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span>
                <span class="n">project_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span>
                <span class="n">classification_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">classification_method</span><span class="p">,</span>
                <span class="n">cindex_thres</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cindex_thres</span><span class="p">,</span>
                <span class="n">alternative_embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span><span class="p">,</span>
                <span class="n">kwargs_alternative_embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs_alternative_embedding</span><span class="p">,</span>
                <span class="n">node_selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_selection</span><span class="p">,</span>
                <span class="n">metadata_usage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_usage</span><span class="p">,</span>
                <span class="n">feature_selection_usage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_selection_usage</span><span class="p">,</span>
                <span class="n">deep_model_additional_args</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">_autoencoder_parameters</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">pretrained_labels_files</span><span class="p">:</span>
                <span class="n">nb_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pretrained_labels_files</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nb_files</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s1">&#39;Number of pretrained label files&#39;</span> \
                        <span class="s1">&#39; inferior to number of instance</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">nb_files</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[:</span><span class="n">nb_files</span><span class="p">]</span>

                <span class="n">results</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">([</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_partial_fit_model_with_pretrained_pool</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
                        <span class="n">labels</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span>
                                             <span class="n">pretrained_labels_files</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">([</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_partial_fit_model_pool</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">])</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Results: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span> <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">is_fitted</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_fitted</span><span class="p">]</span>

            <span class="n">nb_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> models fitted&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_models</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;nb. models fitted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_models</span>

            <span class="k">assert</span><span class="p">(</span><span class="n">nb_models</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;failure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;fitting time (s)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_selection</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;weighted_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;weighted_max&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collect_cindex_for_test_fold</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pretrained_labels_files</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if pretrained_labels_files, is given, the models are constructed using these labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fit models...&#39;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">SimDeep</span><span class="p">(</span>
                <span class="n">nb_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_clusters</span><span class="p">,</span>
                <span class="n">nb_selected_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_selected_features</span><span class="p">,</span>
                <span class="n">pvalue_thres</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvalue_thres</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                <span class="n">load_existing_models</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">_isboosting</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">do_KM_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">cluster_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_method</span><span class="p">,</span>
                <span class="n">use_autoencoders</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_autoencoders</span><span class="p">,</span>
                <span class="n">feature_surv_analysis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_surv_analysis</span><span class="p">,</span>
                <span class="n">path_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span>
                <span class="n">project_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span>
                <span class="n">cindex_thres</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cindex_thres</span><span class="p">,</span>
                <span class="n">node_selection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_selection</span><span class="p">,</span>
                <span class="n">metadata_usage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_usage</span><span class="p">,</span>
                <span class="n">feature_selection_usage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_selection_usage</span><span class="p">,</span>
                <span class="n">alternative_embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alternative_embedding</span><span class="p">,</span>
                <span class="n">kwargs_alternative_embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs_alternative_embedding</span><span class="p">,</span>
                <span class="n">classification_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">classification_method</span><span class="p">,</span>
                <span class="n">deep_model_additional_args</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">_autoencoder_parameters</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">pretrained_labels_files</span><span class="p">:</span>
                <span class="n">nb_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pretrained_labels_files</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nb_files</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s1">&#39;Number of pretrained label files&#39;</span> \
                        <span class="s1">&#39; inferior to number of instance</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">nb_files</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[:</span><span class="n">nb_files</span><span class="p">]</span>

                <span class="n">results</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_partial_fit_model_with_pretrained_pool</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="n">pretrained_labels_files</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">_partial_fit_model_pool</span><span class="p">()</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Results: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span> <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">is_fitted</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_fitted</span><span class="p">]</span>

            <span class="n">nb_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> models fitted&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_models</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;nb. models fitted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_models</span>

            <span class="k">assert</span><span class="p">(</span><span class="n">nb_models</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;failure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;fitting time (s)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_selection</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;weighted_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;weighted_max&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collect_cindex_for_test_fold</span><span class="p">()</span>

<div class="viewcode-block" id="SimDeepBoosting.predict_labels_on_test_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.predict_labels_on_test_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">predict_labels_on_test_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;predict labels on test datasets...&#39;</span><span class="p">)</span>
        <span class="n">test_labels_proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_models_attr</span><span class="p">(</span>
            <span class="s1">&#39;test_labels_proba&#39;</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_class_selection</span><span class="p">(</span>
            <span class="n">test_labels_proba</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cindex_test_folds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span> <span class="o">=</span> <span class="n">res</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#### Report of assigned cluster for TEST dataset </span><span class="si">{0}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;class: </span><span class="si">{0}</span><span class="s1">, number of samples :</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;survival_test&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">nbdays</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span><span class="p">,</span> <span class="n">pvalue_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_test_coxph</span><span class="p">(</span>
            <span class="s1">&#39;KM_plot_boosting_test&#39;</span><span class="p">,</span>
            <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue test </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue proba test </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pvalue_proba</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue cat test </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pvalue_cat</span>

        <span class="n">sample_id_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;sample_ids_test&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_from_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;_write_labels&#39;</span><span class="p">,</span>
                         <span class="n">sample_id_test</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">,</span>
                         <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_test_labels&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">),</span>
                         <span class="n">labels_proba</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">nbdays</span><span class="o">=</span><span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span><span class="o">=</span><span class="n">isdead</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span></div>

<div class="viewcode-block" id="SimDeepBoosting.compute_pvalue_for_merged_test_fold"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.compute_pvalue_for_merged_test_fold">[docs]</a>    <span class="k">def</span> <span class="nf">compute_pvalue_for_merged_test_fold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;predict labels on test fold datasets...&#39;</span><span class="p">)</span>

        <span class="n">isdead_cv</span><span class="p">,</span> <span class="n">nbdays_cv</span><span class="p">,</span> <span class="n">labels_cv</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_usage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">metadata_tsv</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">survival_cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;survival_cv&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">survival_cv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No survival dataset for CV fold returning&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="n">survival_cv</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">nbdays_cv</span> <span class="o">+=</span> <span class="n">nbdays</span>
            <span class="n">isdead_cv</span> <span class="o">+=</span> <span class="n">isdead</span>
            <span class="n">labels_cv</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;cv_labels&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">metadata_mat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">meta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;metadata_mat_cv&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata_mat</span><span class="p">):</span>
                    <span class="n">metadata_mat</span> <span class="o">=</span> <span class="n">meta2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">metadata_mat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metadata_mat</span><span class="p">,</span> <span class="n">meta2</span><span class="p">])</span>

                <span class="n">metadata_mat</span> <span class="o">=</span> <span class="n">metadata_mat</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">pvalue</span> <span class="o">=</span> <span class="n">coxph</span><span class="p">(</span>
            <span class="n">labels_cv</span><span class="p">,</span> <span class="n">isdead_cv</span><span class="p">,</span> <span class="n">nbdays_cv</span><span class="p">,</span>
            <span class="n">isfactor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">do_KM_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_KM_plot</span><span class="p">,</span>
            <span class="n">png_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span>
            <span class="n">fig_name</span><span class="o">=</span><span class="s1">&#39;cv_analysis&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pvalue for test fold concatenated: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pvalue</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue cv test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue</span>

        <span class="k">return</span> <span class="n">pvalue</span></div>

<div class="viewcode-block" id="SimDeepBoosting.collect_pvalue_on_test_fold"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.collect_pvalue_on_test_fold">[docs]</a>    <span class="k">def</span> <span class="nf">collect_pvalue_on_test_fold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;predict labels on test fold datasets...&#39;</span><span class="p">)</span>

        <span class="n">pvalues</span><span class="p">,</span> <span class="n">pvalues_proba</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">pvalues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;cp_pvalue&#39;</span><span class="p">))</span>
            <span class="n">pvalues_proba</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;cp_pvalue_proba&#39;</span><span class="p">))</span>

        <span class="n">pvalue_gmean</span><span class="p">,</span> <span class="n">pvalue_proba_gmean</span> <span class="o">=</span> <span class="n">gmean</span><span class="p">(</span><span class="n">pvalues</span><span class="p">),</span> <span class="n">gmean</span><span class="p">(</span><span class="n">pvalues_proba</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;geo mean pvalues: </span><span class="si">{0}</span><span class="s1"> geo mean pvalues probas: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">pvalue_gmean</span><span class="p">,</span> <span class="n">pvalue_proba_gmean</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue geo mean test fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue_gmean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue proba geo mean test fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue_proba_gmean</span>

        <span class="k">return</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">pvalues_proba</span></div>

<div class="viewcode-block" id="SimDeepBoosting.collect_pvalue_on_training_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.collect_pvalue_on_training_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">collect_pvalue_on_training_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;predict labels on training datasets...&#39;</span><span class="p">)</span>
        <span class="n">pvalues</span><span class="p">,</span> <span class="n">pvalues_proba</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">pvalues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;train_pvalue&#39;</span><span class="p">))</span>
            <span class="n">pvalues_proba</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;train_pvalue_proba&#39;</span><span class="p">))</span>

        <span class="n">pvalue_gmean</span><span class="p">,</span> <span class="n">pvalue_proba_gmean</span> <span class="o">=</span> <span class="n">gmean</span><span class="p">(</span><span class="n">pvalues</span><span class="p">),</span> <span class="n">gmean</span><span class="p">(</span><span class="n">pvalues_proba</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;training geo mean pvalues: </span><span class="si">{0}</span><span class="s1"> geo mean pvalues probas: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">pvalue_gmean</span><span class="p">,</span> <span class="n">pvalue_proba_gmean</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue geo mean train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue_gmean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue proba geo mean train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue_proba_gmean</span>

        <span class="k">return</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">pvalues_proba</span></div>

<div class="viewcode-block" id="SimDeepBoosting.collect_pvalue_on_test_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.collect_pvalue_on_test_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">collect_pvalue_on_test_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;collect pvalues on test datasets...&#39;</span><span class="p">)</span>

        <span class="n">pvalues</span><span class="p">,</span> <span class="n">pvalues_proba</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">pvalues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;test_pvalue&#39;</span><span class="p">))</span>
            <span class="n">pvalues_proba</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;test_pvalue_proba&#39;</span><span class="p">))</span>

        <span class="n">pvalue_gmean</span><span class="p">,</span> <span class="n">pvalue_proba_gmean</span> <span class="o">=</span> <span class="n">gmean</span><span class="p">(</span><span class="n">pvalues</span><span class="p">),</span> <span class="n">gmean</span><span class="p">(</span><span class="n">pvalues_proba</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;test geo mean pvalues: </span><span class="si">{0}</span><span class="s1"> geo mean pvalues probas: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">pvalue_gmean</span><span class="p">,</span> <span class="n">pvalue_proba_gmean</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue geo mean test </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pvalue_gmean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue proba geo mean test </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pvalue_proba_gmean</span>

        <span class="k">return</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">pvalues_proba</span></div>

<div class="viewcode-block" id="SimDeepBoosting.collect_pvalue_on_full_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.collect_pvalue_on_full_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">collect_pvalue_on_full_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;collect pvalues on full datasets...&#39;</span><span class="p">)</span>

        <span class="n">pvalues</span><span class="p">,</span> <span class="n">pvalues_proba</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_models</span><span class="p">(</span><span class="s1">&#39;_get_pvalues_and_pvalues_proba&#39;</span><span class="p">))</span>
        <span class="n">pvalue_gmean</span><span class="p">,</span> <span class="n">pvalue_proba_gmean</span> <span class="o">=</span> <span class="n">gmean</span><span class="p">(</span><span class="n">pvalues</span><span class="p">),</span> <span class="n">gmean</span><span class="p">(</span><span class="n">pvalues_proba</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;full geo mean pvalues: </span><span class="si">{0}</span><span class="s1"> geo mean pvalues probas: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">pvalue_gmean</span><span class="p">,</span> <span class="n">pvalue_proba_gmean</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue geo mean full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue_gmean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue proba geo mean full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue_proba_gmean</span>

        <span class="k">return</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">pvalues_proba</span></div>

<div class="viewcode-block" id="SimDeepBoosting.collect_number_of_features_per_omic"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.collect_number_of_features_per_omic">[docs]</a>    <span class="k">def</span> <span class="nf">collect_number_of_features_per_omic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;number of features per omics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">valid_node_ids_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;valid_node_ids_array&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">valid_node_ids_array</span><span class="p">:</span>
                <span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_node_ids_array</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">counter</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;key:</span><span class="si">{0}</span><span class="s1"> mean: </span><span class="si">{1}</span><span class="s1"> std: </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;number of features per omics&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">counter</span></div>


<div class="viewcode-block" id="SimDeepBoosting.collect_cindex_for_test_fold"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.collect_cindex_for_test_fold">[docs]</a>    <span class="k">def</span> <span class="nf">collect_cindex_for_test_fold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cindex_test_folds</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_from_models</span><span class="p">(</span><span class="s1">&#39;predict_labels_on_test_fold&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cindexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_models</span><span class="p">(</span><span class="s1">&#39;compute_c_indexes_for_test_fold_dataset&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception while computing the c-index for test fold: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">for</span> <span class="n">cindex</span> <span class="ow">in</span> <span class="n">cindexes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cindex</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cindex</span><span class="p">,</span> <span class="n">NALogicalType</span><span class="p">):</span>
                <span class="n">cindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cindex_test_folds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cindex</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cindex_test_folds</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cindex_test_folds</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;C-index results for test fold: mean </span><span class="si">{0}</span><span class="s1"> std </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;c-indexes test fold (mean)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cindex_test_folds</span></div>


<div class="viewcode-block" id="SimDeepBoosting.collect_cindex_for_full_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.collect_cindex_for_full_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">collect_cindex_for_full_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_models</span><span class="p">(</span><span class="s1">&#39;predict_labels_on_test_fold&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cindexes_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_models</span><span class="p">(</span><span class="s1">&#39;compute_c_indexes_for_full_dataset&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception while computing the c-index for full dataset: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index results for full dataset: mean </span><span class="si">{0}</span><span class="s1"> std </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cindexes_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cindexes_list</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;c-indexes full (mean)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cindexes_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cindexes_list</span></div>


<div class="viewcode-block" id="SimDeepBoosting.collect_cindex_for_training_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.collect_cindex_for_training_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">collect_cindex_for_training_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cindexes_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_models</span><span class="p">(</span><span class="s1">&#39;compute_c_indexes_for_training_dataset&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception while computing the c-index for training dataset: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;c-indexes train (mean)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;C-index results for training dataset: mean </span><span class="si">{0}</span><span class="s1"> std </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cindexes_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cindexes_list</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;c-indexes train (mean)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cindexes_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cindexes_list</span></div>

<div class="viewcode-block" id="SimDeepBoosting.collect_cindex_for_test_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.collect_cindex_for_test_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">collect_cindex_for_test_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cindexes_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_models</span><span class="p">(</span><span class="s1">&#39;compute_c_indexes_for_test_dataset&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception while computing the c-index for test dataset: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;C-index test </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;C-index results for test: mean </span><span class="si">{0}</span><span class="s1"> std </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cindexes_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cindexes_list</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;C-index test </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cindexes_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cindexes_list</span></div>

<div class="viewcode-block" id="SimDeepBoosting.predict_labels_on_full_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.predict_labels_on_full_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">predict_labels_on_full_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;predict labels on full datasets...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_probas_for_full_models</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reorder_survival_full_and_metadata</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#### Report of assigned cluster for the full training dataset:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;class: </span><span class="si">{0}</span><span class="s1">, number of samples :</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_full</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>


        <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span><span class="p">,</span> <span class="n">pvalue_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_test_coxph</span><span class="p">(</span>
            <span class="s1">&#39;KM_plot_boosting_full&#39;</span><span class="p">,</span>
            <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_project_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue proba full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue_proba</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;pvalue cat full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue_cat</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_from_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;_write_labels&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids_full</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">,</span>
                          <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_full_labels&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project_name</span><span class="p">),</span>
                          <span class="n">labels_proba</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">nbdays</span><span class="o">=</span><span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span><span class="o">=</span><span class="n">isdead</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span></div>

<div class="viewcode-block" id="SimDeepBoosting.compute_clusters_consistency_for_full_labels"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.compute_clusters_consistency_for_full_labels">[docs]</a>    <span class="k">def</span> <span class="nf">compute_clusters_consistency_for_full_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">model_1</span><span class="p">,</span> <span class="n">model_2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">full_labels_1_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model_1</span><span class="p">,</span> <span class="s1">&#39;full_labels&#39;</span><span class="p">)</span>
            <span class="n">full_labels_2_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model_2</span><span class="p">,</span> <span class="s1">&#39;full_labels&#39;</span><span class="p">)</span>

            <span class="n">full_ids_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="n">model_1</span><span class="p">,</span> <span class="s1">&#39;sample_ids_full&#39;</span><span class="p">)</span>
            <span class="n">full_ids_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="n">model_2</span><span class="p">,</span> <span class="s1">&#39;sample_ids_full&#39;</span><span class="p">)</span>

            <span class="n">full_labels_1</span> <span class="o">=</span> <span class="n">_reorder_labels</span><span class="p">(</span><span class="n">full_labels_1_old</span><span class="p">,</span> <span class="n">full_ids_1</span><span class="p">)</span>
            <span class="n">full_labels_2</span> <span class="o">=</span> <span class="n">_reorder_labels</span><span class="p">(</span><span class="n">full_labels_2_old</span><span class="p">,</span> <span class="n">full_ids_2</span><span class="p">)</span>

            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adjusted_rand_score</span><span class="p">(</span><span class="n">full_labels_1</span><span class="p">,</span>
                                              <span class="n">full_labels_2</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adj. Rand scores for full label: mean: </span><span class="si">{0}</span><span class="s1"> std: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">scores</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;Adj. Rand scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scores</span></div>

<div class="viewcode-block" id="SimDeepBoosting.compute_clusters_consistency_for_test_labels"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.compute_clusters_consistency_for_test_labels">[docs]</a>    <span class="k">def</span> <span class="nf">compute_clusters_consistency_for_test_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">model_1</span><span class="p">,</span> <span class="n">model_2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adjusted_rand_score</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model_1</span><span class="p">,</span> <span class="s1">&#39;test_labels&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model_2</span><span class="p">,</span> <span class="s1">&#39;test_labels&#39;</span><span class="p">),</span>
            <span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adj. Rand scores for test label: mean: </span><span class="si">{0}</span><span class="s1"> std: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">scores</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;Adj. Rand scores test </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scores</span></div>

    <span class="k">def</span> <span class="nf">_reorder_survival_full_and_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">survival_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;survival_full&#39;</span><span class="p">)</span>
        <span class="n">sample_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;sample_ids_full&#39;</span><span class="p">)</span>

        <span class="n">surv_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">sample</span><span class="p">:</span> <span class="n">surv</span> <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">surv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">survival_old</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">survival_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">surv_dict</span><span class="p">[</span><span class="n">sample</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                                         <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids_full</span><span class="p">])</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;metadata_mat_full&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">index_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">sample</span><span class="p">:</span> <span class="n">pos</span> <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">)}</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">index_dict</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids_full</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_mat_full</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">_reorder_matrix_full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sample_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;sample_ids_full&#39;</span><span class="p">)</span>
        <span class="n">index_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">sample</span><span class="p">:</span> <span class="n">ids</span> <span class="k">for</span> <span class="n">ids</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">)}</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_dict</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids_full</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">matrix_with_cv_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;matrix_array&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">matrix_cv_unormalized_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;matrix_cv_unormalized_array&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_with_cv_array</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matrix_cv_unormalized_array</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matrix_with_cv_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix_with_cv_array</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                     <span class="n">matrix_cv_unormalized_array</span><span class="p">[</span><span class="n">key</span><span class="p">]])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">matrix_with_cv_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_with_cv_array</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_probas_for_full_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">proba_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sample_proba</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_models</span><span class="p">(</span><span class="s1">&#39;_get_probas_for_full_model&#39;</span><span class="p">):</span>
            <span class="n">sample_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">proba</span> <span class="ow">in</span> <span class="n">sample_proba</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sample_set</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">proba_dict</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">proba</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
                <span class="n">sample_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

        <span class="n">labels</span><span class="p">,</span> <span class="n">probas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_class_selection</span><span class="p">(</span><span class="n">hstack</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">proba_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
                                                 <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cindex_test_folds</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span> <span class="o">=</span> <span class="n">probas</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids_full</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">proba_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_compute_test_coxph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span>
                            <span class="n">isdead</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">labels_proba</span><span class="p">,</span>
                            <span class="n">project_name</span><span class="p">,</span> <span class="n">metadata_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">pvalue</span> <span class="o">=</span> <span class="n">coxph</span><span class="p">(</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span>
            <span class="n">isfactor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">do_KM_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_KM_plot</span><span class="p">,</span>
            <span class="n">png_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span>
            <span class="n">fig_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">),</span>
            <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cox-PH p-value (Log-Rank) for inferred labels: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pvalue</span><span class="p">))</span>

        <span class="n">pvalue_proba</span> <span class="o">=</span> <span class="n">coxph</span><span class="p">(</span>
            <span class="n">labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span>
            <span class="n">isfactor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cox-PH proba p-value (Log-Rank) for inferred labels: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pvalue_proba</span><span class="p">))</span>

        <span class="n">labels_categorical</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_proba_to_labels</span><span class="p">(</span><span class="n">labels_proba</span><span class="p">)</span>

        <span class="n">pvalue_cat</span> <span class="o">=</span> <span class="n">coxph</span><span class="p">(</span>
            <span class="n">labels_categorical</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span>
            <span class="n">isfactor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">do_KM_plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_KM_plot</span><span class="p">,</span>
            <span class="n">png_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span>
            <span class="n">fig_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_proba_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">fname_base</span><span class="p">),</span>
            <span class="n">metadata_mat</span><span class="o">=</span><span class="n">metadata_mat</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cox-PH categorical p-value (Log-Rank) for inferred labels: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">pvalue_cat</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue_proba</span><span class="p">,</span> <span class="n">pvalue_cat</span>

    <span class="k">def</span> <span class="nf">_labels_proba_to_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels_proba</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">probas</span> <span class="o">=</span> <span class="n">labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">probas</span><span class="p">))</span>
        <span class="n">nb_clusters</span> <span class="o">=</span> <span class="n">labels_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_clusters</span><span class="p">):</span>
            <span class="n">percentile</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">cluster</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">probas</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">probas</span> <span class="o">&gt;=</span> <span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_clusters</span> <span class="o">-</span> <span class="n">cluster</span>

        <span class="k">return</span> <span class="n">labels</span>

<div class="viewcode-block" id="SimDeepBoosting.compute_c_indexes_for_test_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.compute_c_indexes_for_test_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">compute_c_indexes_for_test_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return c-index using labels as predicat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">days_full</span><span class="p">,</span> <span class="n">dead_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survival_full</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">days_test</span><span class="p">,</span> <span class="n">dead_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;survival_test&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">days_test</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot compute C-index for test dataset. Need test survival file&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">labels_test_categorical</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_proba_to_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">days_test</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">):</span>
            <span class="n">days_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">days_test</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dead_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dead_test</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">cindex</span> <span class="o">=</span> <span class="n">c_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">,</span> <span class="n">dead_full</span><span class="p">,</span> <span class="n">days_full</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">dead_test</span><span class="p">,</span> <span class="n">days_test</span><span class="p">,</span>
                         <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">cindex_cat</span> <span class="o">=</span> <span class="n">c_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">,</span> <span class="n">dead_full</span><span class="p">,</span> <span class="n">days_full</span><span class="p">,</span>
                             <span class="n">labels_test_categorical</span><span class="p">,</span> <span class="n">dead_test</span><span class="p">,</span> <span class="n">days_test</span><span class="p">,</span>
                             <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">cindex_proba</span> <span class="o">=</span> <span class="n">c_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dead_full</span><span class="p">,</span> <span class="n">days_full</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dead_test</span><span class="p">,</span> <span class="n">days_test</span><span class="p">,</span>
                               <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index for boosting test dataset:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index proba for boosting test dataset:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex_proba</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index cat for boosting test dataset:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex_cat</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;c-index test boosting </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cindex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;c-index proba test boosting </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cindex_proba</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;c-index cat test boosting </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cindex_cat</span>

        <span class="k">return</span> <span class="n">cindex</span></div>

<div class="viewcode-block" id="SimDeepBoosting.compute_c_indexes_for_full_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.compute_c_indexes_for_full_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">compute_c_indexes_for_full_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return c-index using labels as predicat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">days_full</span><span class="p">,</span> <span class="n">dead_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">survival_full</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">labels_categorical</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_proba_to_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span><span class="p">)</span>

        <span class="n">cindex</span> <span class="o">=</span> <span class="n">c_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">,</span> <span class="n">dead_full</span><span class="p">,</span> <span class="n">days_full</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">,</span> <span class="n">dead_full</span><span class="p">,</span> <span class="n">days_full</span><span class="p">,</span>
                         <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">cindex_cat</span> <span class="o">=</span> <span class="n">c_index</span><span class="p">(</span><span class="n">labels_categorical</span><span class="p">,</span> <span class="n">dead_full</span><span class="p">,</span> <span class="n">days_full</span><span class="p">,</span>
                             <span class="n">labels_categorical</span><span class="p">,</span> <span class="n">dead_full</span><span class="p">,</span> <span class="n">days_full</span><span class="p">,</span>
                             <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">cindex_proba</span> <span class="o">=</span> <span class="n">c_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dead_full</span><span class="p">,</span> <span class="n">days_full</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dead_full</span><span class="p">,</span> <span class="n">days_full</span><span class="p">,</span>
                               <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index for boosting full dataset:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index proba for boosting full dataset:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex_proba</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c-index cat for boosting full dataset:</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex_cat</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;c-index full boosting </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cindex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;c-index proba full boosting </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cindex_proba</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;c-index cat full boosting </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cindex_cat</span>

        <span class="k">return</span> <span class="n">cindex</span></div>

<div class="viewcode-block" id="SimDeepBoosting.compute_c_indexes_multiple_for_test_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.compute_c_indexes_multiple_for_test_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">compute_c_indexes_multiple_for_test_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Not Functionnal !</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;not funtionnal!&#39;</span><span class="p">)</span>
        <span class="k">return</span>

        <span class="n">matrix_array_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;matrix_ref_array&#39;</span><span class="p">)</span>
        <span class="n">matrix_array_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;matrix_test_array&#39;</span><span class="p">)</span>

        <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                  <span class="s1">&#39;survival&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">nbdays_test</span><span class="p">,</span> <span class="n">isdead_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                            <span class="s1">&#39;survival_test&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">activities_train</span><span class="p">,</span> <span class="n">activities_test</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">activities_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict_nodes_activities</span><span class="p">(</span><span class="n">matrix_array_train</span><span class="p">))</span>
            <span class="n">activities_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict_nodes_activities</span><span class="p">(</span><span class="n">matrix_array_test</span><span class="p">))</span>

        <span class="n">activities_train</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="n">activities_train</span><span class="p">)</span>
        <span class="n">activities_test</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">(</span><span class="n">activities_test</span><span class="p">)</span>

        <span class="n">cindex</span> <span class="o">=</span> <span class="n">c_index_multiple</span><span class="p">(</span>
            <span class="n">activities_train</span><span class="p">,</span> <span class="n">isdead</span><span class="p">,</span> <span class="n">nbdays</span><span class="p">,</span>
            <span class="n">activities_test</span><span class="p">,</span> <span class="n">isdead_test</span><span class="p">,</span> <span class="n">nbdays_test</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;total number of survival features: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">activities_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cindex multiple for test set: </span><span class="si">{0}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cindex</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;c-index multiple test </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cindex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;Number of survival features </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">activities_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">cindex</span></div>

<div class="viewcode-block" id="SimDeepBoosting.plot_supervised_predicted_labels_for_test_sets"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.plot_supervised_predicted_labels_for_test_sets">[docs]</a>    <span class="k">def</span> <span class="nf">plot_supervised_predicted_labels_for_test_sets</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">define_as_main_kernel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">use_main_kernel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#### plotting supervised labels....&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_from_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;plot_supervised_kernel_for_test_sets&quot;</span><span class="p">,</span>
                         <span class="n">define_as_main_kernel</span><span class="o">=</span><span class="n">define_as_main_kernel</span><span class="p">,</span>
                         <span class="n">use_main_kernel</span><span class="o">=</span><span class="n">use_main_kernel</span><span class="p">,</span>
                         <span class="n">test_labels_proba</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="p">,</span>
                         <span class="n">test_labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">,</span>
                         <span class="n">key</span><span class="o">=</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimDeepBoosting.plot_supervised_kernel_for_test_sets"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.plot_supervised_kernel_for_test_sets">[docs]</a>    <span class="k">def</span> <span class="nf">plot_supervised_kernel_for_test_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">simdeep.plot_utils</span> <span class="kn">import</span> <span class="n">plot_kernel_plots</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plotting survival features using autoencoder...&#39;</span><span class="p">)</span>

        <span class="n">encoder_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_autoencoder_for_kernel_plot</span><span class="p">()</span>
        <span class="n">activities</span><span class="p">,</span> <span class="n">activities_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_kde_matrices</span><span class="p">(</span>
            <span class="n">encoder_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_test_array</span><span class="p">)</span>

        <span class="n">html_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">_</span><span class="si">{2}</span><span class="s1">_supervised_kdeplot.html&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">)</span>

        <span class="n">plot_kernel_plots</span><span class="p">(</span>
            <span class="n">test_labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_labels</span><span class="p">,</span>
            <span class="n">test_labels_proba</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_labels_proba</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">,</span>
            <span class="n">activities</span><span class="o">=</span><span class="n">activities</span><span class="p">,</span>
            <span class="n">activities_test</span><span class="o">=</span><span class="n">activities_test</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span>
            <span class="n">path_html</span><span class="o">=</span><span class="n">html_name</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_predict_kde_survival_nodes_for_train_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kde_survival_node_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">encoder_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_for_kde_plot_dict</span><span class="p">[</span><span class="n">encoder_key</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">encoder_array</span><span class="p">:</span>
            <span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">matrix_ref</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_ref_array</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

            <span class="n">survival_node_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;_look_for_survival_nodes&#39;</span><span class="p">,</span>
                <span class="n">activities</span><span class="o">=</span><span class="n">matrix_ref</span><span class="p">,</span> <span class="n">survival</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">survival</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">kde_survival_node_ids</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">survival_node_ids</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kde_train_matrices</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix_ref</span>

    <span class="k">def</span> <span class="nf">_predict_kde_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_key</span><span class="p">,</span>
                              <span class="n">matrix_test_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matrix_test_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">matrix_ref_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">encoder_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_for_kde_plot_dict</span><span class="p">[</span><span class="n">encoder_key</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">matrix_test_array</span><span class="p">:</span>
            <span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">matrix_test</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">matrix_test_array</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">matrix_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kde_train_matrices</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">survival_node_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kde_survival_node_ids</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">survival_node_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">matrix_test</span> <span class="o">=</span> <span class="n">matrix_test</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">survival_node_ids</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">matrix_ref</span> <span class="o">=</span> <span class="n">matrix_ref</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">survival_node_ids</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;not enough survival nodes to construct kernel for key: </span><span class="si">{0}</span><span class="s1">&#39;</span> \
                          <span class="s1">&#39;skipping the </span><span class="si">{0}</span><span class="s1"> matrix&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">matrix_ref_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matrix_ref</span><span class="p">)</span>
            <span class="n">matrix_test_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matrix_test</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">matrix_ref_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;</span><span class="se">\n</span><span class="s1">&#39;</span> \
                      <span class="s1">&#39; matrix_ref_list / matrix_test_list empty!&#39;</span> \
                      <span class="s1">&#39;take the last OMIC (</span><span class="si">{0}</span><span class="s1">) matrix as ref </span><span class="se">\n</span><span class="s1">&#39;</span> \
                      <span class="s1">&#39;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;&lt;!&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">matrix_ref_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matrix_ref</span><span class="p">)</span>
            <span class="n">matrix_test_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matrix_test</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hstack</span><span class="p">(</span><span class="n">matrix_ref_list</span><span class="p">),</span> <span class="n">hstack</span><span class="p">(</span><span class="n">matrix_test_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_autoencoder_for_kernel_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key_normalization</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="n">encoder_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_normalization</span><span class="p">)</span>
        <span class="n">encoder_key</span> <span class="o">=</span> <span class="s1">&#39;omic:</span><span class="si">{0}</span><span class="s1"> normalisation: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_tsv_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">encoder_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">encoder_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_for_kde_plot_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loading test data for plotting...&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">load_new_test_dataset</span><span class="p">(</span>
                <span class="n">tsv_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_tsv_dict</span><span class="p">,</span>
                <span class="n">path_survival_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_survival_file</span><span class="p">,</span>
                <span class="n">normalization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">encoder_key</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">LoadData</span><span class="p">(</span>
            <span class="n">cross_validation_instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">training_tsv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_tsv</span><span class="p">,</span>
            <span class="n">survival_tsv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">survival_tsv</span><span class="p">,</span>
            <span class="n">metadata_tsv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_tsv</span><span class="p">,</span>
            <span class="n">survival_flag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">survival_flag</span><span class="p">,</span>
            <span class="n">path_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_data</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">normalization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span><span class="p">,</span>
            <span class="n">subset_training_with_meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subset_training_with_meta</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;preparing data for plotting...&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">load_array</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">load_survival</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">load_meta_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">subset_training_sets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">reorder_matrix_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids_full</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">create_a_cv_split</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">normalize_training_array</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">load_new_test_dataset</span><span class="p">(</span>
            <span class="n">tsv_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_tsv_dict</span><span class="p">,</span>
            <span class="n">path_survival_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_survival_file</span><span class="p">,</span>
            <span class="n">normalization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fitting autoencoder for plotting...&#39;</span><span class="p">)</span>

        <span class="n">autoencoder</span> <span class="o">=</span> <span class="n">DeepBase</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span>
                               <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                               <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

        <span class="n">autoencoder</span><span class="o">.</span><span class="n">matrix_train_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">matrix_ref_array</span>

        <span class="c1"># label_encoded = OneHotEncoder().fit_transform(</span>
        <span class="c1">#     self.full_labels.reshape(-1, 1)).todense()</span>

        <span class="c1"># autoencoder.construct_supervized_network(label_encoded)</span>

        <span class="n">autoencoder</span><span class="o">.</span><span class="n">construct_supervized_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels_proba</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_for_kde_plot_dict</span><span class="p">[</span><span class="n">encoder_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">encoder_array</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fitting done!&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_predict_kde_survival_nodes_for_train_matrices</span><span class="p">(</span><span class="n">encoder_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">encoder_key</span>

<div class="viewcode-block" id="SimDeepBoosting.load_new_test_dataset"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.load_new_test_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">load_new_test_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsv_dict</span><span class="p">,</span>
                              <span class="n">fname_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">path_survival_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">normalization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">survival_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">metadata_file</span><span class="o">=</span><span class="kc">None</span>
                              <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_tsv_dict</span> <span class="o">=</span> <span class="n">tsv_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_survival_file</span> <span class="o">=</span> <span class="n">path_survival_file</span>

        <span class="k">if</span> <span class="n">normalization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">normalization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalization</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_normalization</span> <span class="o">=</span> <span class="n">normalization</span>

        <span class="k">if</span> <span class="n">debug</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_threads</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># for model in self.models:</span>
        <span class="c1"># model.verbose = True</span>
        <span class="c1"># model.dataset.verbose = True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span> <span class="o">=</span> <span class="n">fname_key</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading new test dataset </span><span class="si">{0}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">))</span>
        <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_from_models</span><span class="p">(</span><span class="s1">&#39;_predict_new_dataset&#39;</span><span class="p">,</span>
                          <span class="n">tsv_dict</span><span class="o">=</span><span class="n">tsv_dict</span><span class="p">,</span>
                          <span class="n">path_survival_file</span><span class="o">=</span><span class="n">path_survival_file</span><span class="p">,</span>
                          <span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span><span class="p">,</span>
                          <span class="n">survival_flag</span><span class="o">=</span><span class="n">survival_flag</span><span class="p">,</span>
                          <span class="n">metadata_file</span><span class="o">=</span><span class="n">metadata_file</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test dataset </span><span class="si">{1}</span><span class="s2"> loaded in </span><span class="si">{0}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_fname_key</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">fname_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project_name</span><span class="p">,</span> <span class="n">fname_key</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimDeepBoosting.compute_survival_feature_scores_per_cluster"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.compute_survival_feature_scores_per_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">compute_survival_feature_scores_per_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                    <span class="n">pval_thres</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                                                    <span class="n">use_meta</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;computing survival feature importance per cluster...&#39;</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_threads</span><span class="p">)</span>
        <span class="n">mapf</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_usage</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;new-features&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">use_meta</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">metadata_mat_full</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_mat_full</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_mat</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">survival_feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">feature_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;feature_array&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="n">feature_list</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">feature_index</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feature_list</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">feature_index</span><span class="p">[</span><span class="n">feat</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">feat</span><span class="p">,</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">survival_full</span><span class="p">,</span>
                       <span class="n">metadata_mat</span><span class="p">,</span>
                       <span class="n">pval_thres</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_with_cv_array</span><span class="p">:</span>
            <span class="n">feature_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">feat</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feature_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])}</span>

            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">:</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_with_cv_array</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span>

                <span class="n">feature_list</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                <span class="n">feature_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span> <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feature_list</span>
                                <span class="k">if</span> <span class="n">feat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">feature_index</span><span class="p">]</span>

                <span class="n">input_list</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">feature_list</span><span class="p">,</span> <span class="n">matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">feature_index</span><span class="p">)</span>

                <span class="n">features_scored</span> <span class="o">=</span> <span class="n">mapf</span><span class="p">(</span>
                    <span class="n">_process_parallel_survival_feature_importance_per_cluster</span><span class="p">,</span>
                    <span class="n">input_list</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">pvalue</span> <span class="ow">in</span> <span class="n">features_scored</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">survival_feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_feature_scores_per_cluster</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">survival_feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="SimDeepBoosting.compute_feature_scores_per_cluster"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.compute_feature_scores_per_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">compute_feature_scores_per_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pval_thres</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;computing feature importance per cluster...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reorder_matrix_full</span><span class="p">()</span>
        <span class="n">mapf</span> <span class="o">=</span> <span class="nb">map</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_list</span><span class="p">)):</span>
                <span class="k">yield</span> <span class="n">feature_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">labels</span><span class="p">,</span> <span class="n">pval_thres</span>

        <span class="n">feature_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;feature_array&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_with_cv_array</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_with_cv_array</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_labels</span><span class="p">[:]</span>

            <span class="n">input_list</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">feature_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

            <span class="n">features_scored</span> <span class="o">=</span> <span class="n">mapf</span><span class="p">(</span>
                <span class="n">_process_parallel_feature_importance_per_cluster</span><span class="p">,</span> <span class="n">input_list</span><span class="p">)</span>
            <span class="n">features_scored</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span> <span class="k">for</span> <span class="n">feat_list</span> <span class="ow">in</span> <span class="n">features_scored</span>
                               <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feat_list</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">median_diff</span><span class="p">,</span> <span class="n">pvalue</span> <span class="ow">in</span> <span class="n">features_scored</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="n">feature</span><span class="p">,</span> <span class="n">median_diff</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>

<div class="viewcode-block" id="SimDeepBoosting.write_feature_score_per_cluster"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.write_feature_score_per_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">write_feature_score_per_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f_file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">_features_scores_per_clusters.tsv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_name</span><span class="p">)</span>
        <span class="n">f_anti_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">_features_anticorrelated_scores_per_clusters.tsv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_name</span><span class="p">)</span>

        <span class="n">f_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f_anti_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_anti_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#label</span><span class="se">\t</span><span class="s1">feature</span><span class="se">\t</span><span class="s1">median difference</span><span class="se">\t</span><span class="s1">p-value</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f_anti_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#label</span><span class="se">\t</span><span class="s1">feature</span><span class="se">\t</span><span class="s1">median difference</span><span class="se">\t</span><span class="s1">p-value</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">f_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cluster id</span><span class="se">\t</span><span class="s1">feature</span><span class="se">\t</span><span class="s1">median diff</span><span class="se">\t</span><span class="s1">Wilcoxon p-value</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">median_diff</span><span class="p">,</span> <span class="n">pvalue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">median_diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">f_to_write</span> <span class="o">=</span> <span class="n">f_file</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f_to_write</span> <span class="o">=</span> <span class="n">f_anti_file</span>

                <span class="n">f_to_write</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\t</span><span class="si">{1}</span><span class="se">\t</span><span class="si">{2}</span><span class="se">\t</span><span class="si">{3}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">label</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">median_diff</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> written&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_file_name</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> written&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_anti_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_feature_scores_per_cluster</span><span class="p">:</span>
            <span class="n">f_file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">_survival_features_scores_per_clusters.tsv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_name</span><span class="p">)</span>
            <span class="n">f_to_write</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_file_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f_to_write</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;#label</span><span class="se">\t</span><span class="s1">feature</span><span class="se">\t</span><span class="s1">median difference</span><span class="se">\t</span><span class="s1">cluster logrank p-value</span><span class="se">\t</span><span class="s1">CoxPH Log-rank p-value</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_feature_scores_per_cluster</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">pvalue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">survival_feature_scores_per_cluster</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                    <span class="n">f_to_write</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\t</span><span class="si">{1}</span><span class="se">\t</span><span class="si">{2}</span><span class="se">\t</span><span class="si">{3}</span><span class="se">\t</span><span class="si">{4}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">label</span><span class="p">,</span> <span class="n">feature</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">feature</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">feature</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pvalue</span><span class="p">))</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> written&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_file_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No survival features detected. File: </span><span class="si">{0}</span><span class="s2"> not writtten&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_file_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="SimDeepBoosting.evalutate_cluster_performance"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.evalutate_cluster_performance">[docs]</a>    <span class="k">def</span> <span class="nf">evalutate_cluster_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pretrained_fit</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;model is fitted on pretrained labels&#39;</span> \
                  <span class="s1">&#39; Cannot evaluate cluster performance&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">bic_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;bic_score&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">bic_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">bic_scores</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bic score: mean: </span><span class="si">{0}</span><span class="s1"> std :</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bic_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">bic_scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;bic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bic</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">silhouette_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;silhouette_score&#39;</span><span class="p">)</span>
                                      <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">])</span>
        <span class="n">silhouette</span> <span class="o">=</span> <span class="n">silhouette_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;silhouette score: mean: </span><span class="si">{0}</span><span class="s1"> std :</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">silhouette</span><span class="p">,</span>
                                                            <span class="n">silhouette_scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;silhouette&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">silhouette</span>

        <span class="n">calinski_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;calinski_score&#39;</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">])</span>

        <span class="n">calinski</span> <span class="o">=</span> <span class="n">calinski_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;calinski harabasz score: mean: </span><span class="si">{0}</span><span class="s1"> std :</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">calinski_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                                                                   <span class="n">calinski_scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;calinski&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calinski</span>

        <span class="k">return</span> <span class="n">bic</span><span class="p">,</span> <span class="n">silhouette</span><span class="p">,</span> <span class="n">calinski</span></div>

<div class="viewcode-block" id="SimDeepBoosting.save_cv_models_classes"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.save_cv_models_classes">[docs]</a>    <span class="k">def</span> <span class="nf">save_cv_models_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_results</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_models_classes</span><span class="p">(</span><span class="n">path_results</span><span class="o">=</span><span class="n">path_results</span><span class="p">,</span>
                                 <span class="n">use_cv_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimDeepBoosting.save_test_models_classes"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.save_test_models_classes">[docs]</a>    <span class="k">def</span> <span class="nf">save_test_models_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_results</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_models_classes</span><span class="p">(</span><span class="n">path_results</span><span class="o">=</span><span class="n">path_results</span><span class="p">,</span>
                                 <span class="n">use_test_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimDeepBoosting.save_models_classes"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.save_models_classes">[docs]</a>    <span class="k">def</span> <span class="nf">save_models_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_results</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="n">use_cv_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">use_test_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path_results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_test_labels</span><span class="p">:</span>
                <span class="n">path_results</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/saved_models_test_classes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">use_cv_labels</span><span class="p">:</span>
                <span class="n">path_results</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/saved_models_cv_classes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path_results</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/saved_models_classes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">path_results</span><span class="p">):</span>
            <span class="n">mkdir</span><span class="p">(</span><span class="n">path_results</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">use_test_labels</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;test_labels&#39;</span><span class="p">)</span>
                <span class="n">labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;test_labels_proba&#39;</span><span class="p">)</span>
                <span class="n">sample_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;sample_ids_test&#39;</span><span class="p">)</span>
                <span class="n">survival</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;survival_test&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">use_cv_labels</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;cv_labels&#39;</span><span class="p">)</span>
                <span class="n">labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;cv_labels_proba&#39;</span><span class="p">)</span>
                <span class="n">sample_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;sample_ids_cv&#39;</span><span class="p">)</span>
                <span class="n">survival</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;survival_cv&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span>
                <span class="n">labels_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;labels_proba&#39;</span><span class="p">)</span>
                <span class="n">sample_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;sample_ids&#39;</span><span class="p">)</span>
                <span class="n">survival</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_dataset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;survival&#39;</span><span class="p">)</span>

            <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_model_attr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;seed&#39;</span><span class="p">)</span>

            <span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span> <span class="o">=</span> <span class="n">survival</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">seed</span><span class="p">:</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="n">i</span>

            <span class="n">path_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/model_instance_</span><span class="si">{1}</span><span class="s1">.tsv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">path_results</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>

            <span class="n">labels_proba</span> <span class="o">=</span> <span class="n">labels_proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_from_model</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="s1">&#39;_write_labels&#39;</span><span class="p">,</span>
                <span class="n">sample_ids</span><span class="p">,</span>
                <span class="n">labels</span><span class="p">,</span>
                <span class="n">path_file</span><span class="o">=</span><span class="n">path_file</span><span class="p">,</span>
                <span class="n">labels_proba</span><span class="o">=</span><span class="n">labels_proba</span><span class="p">,</span>
                <span class="n">nbdays</span><span class="o">=</span><span class="n">nbdays</span><span class="p">,</span> <span class="n">isdead</span><span class="o">=</span><span class="n">isdead</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;individual model labels saved at: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_results</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_convert_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">NALogicalType</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<div class="viewcode-block" id="SimDeepBoosting.write_logs"><a class="viewcode-back" href="../../api/simdeep.html#simdeep.simdeep_boosting.SimDeepBoosting.write_logs">[docs]</a>    <span class="k">def</span> <span class="nf">write_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_logs</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">.log.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_name</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span></div></div>


<span class="k">def</span> <span class="nf">_highest_proba</span><span class="p">(</span><span class="n">proba</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">probas</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
        <span class="n">proba_vector</span> <span class="o">=</span> <span class="p">[</span><span class="n">proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">cluster</span><span class="p">][</span><span class="n">sample</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">proba_vector</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">probas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proba_vector</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">probas</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_mean_proba</span><span class="p">(</span><span class="n">proba</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">probas</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
        <span class="n">proba_vector</span> <span class="o">=</span> <span class="p">[</span><span class="n">proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">cluster</span><span class="p">][</span><span class="n">sample</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">proba_vector</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">probas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proba_vector</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">probas</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_weighted_mean</span><span class="p">(</span><span class="n">proba</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">probas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">weights</span><span class="p">[</span><span class="n">weights</span> <span class="o">&lt;</span> <span class="mf">0.50</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">weights</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
        <span class="n">proba_vector</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">cluster</span><span class="p">][</span><span class="n">sample</span><span class="p">])</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">proba_vector</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">probas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proba_vector</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">probas</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_weighted_max</span><span class="p">(</span><span class="n">proba</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">probas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">weights</span><span class="p">[</span><span class="n">weights</span> <span class="o">&lt;</span> <span class="mf">0.50</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">weights</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
        <span class="n">proba_vector</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">proba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">cluster</span><span class="p">][</span><span class="n">sample</span><span class="p">]</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">proba_vector</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">probas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proba_vector</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">probas</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_reorder_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">sample_ids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sample_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">sample</span><span class="p">:</span> <span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">)}</span>
    <span class="n">sample_ordered</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">)</span>

    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_dict</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sample_ordered</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, Olivier Poirion.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>